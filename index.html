<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTributation - Plataforma Unificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --main-bg: #0D1117;
            --card-bg: rgba(22, 27, 34, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #8B949E;
            --text-headings: #C9D1D9;
            --text-white: #FFFFFF;
            --accent-color: #58A6FF;
            --accent-color-hover: #79C0FF;
            --positive-color: #3FB950;
            --negative-color: #F85149;
            --warning-color: #D29922;
            --transition-fluid: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --mouse-x: 50%;
            --mouse-y: 50%;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(88, 166, 255, 0.06), transparent 80%);
            z-index: 0; pointer-events: none;
        }
        .content-wrapper { position: relative; z-index: 1; margin: 2rem auto; padding: 2rem; max-width: 1320px; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .stagger-in {
            animation: fadeInUp 0.6s var(--transition-fluid) both;
            animation-delay: calc(var(--stagger-index) * 80ms);
        }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.7rem 1.4rem; border-radius: 6px; font-weight: 500; transition: var(--transition-fluid); border: 1px solid var(--border-color); transform: scale(1); }
        .btn:hover { transform: scale(1.03); border-color: var(--accent-color); }
        .btn-primary { background-color: var(--accent-color); color: var(--main-bg); font-weight: 600; border-color: var(--accent-color); }
        .btn-primary:hover { background-color: var(--accent-color-hover); border-color: var(--accent-color-hover); }
        .btn-secondary { background-color: transparent; color: var(--text-headings); }
        .btn-secondary:hover { color: var(--accent-color); }
        .btn-danger { background-color: transparent; border-color: var(--negative-color); color: var(--negative-color);}
        .btn-danger:hover { background-color: var(--negative-color); color: var(--text-white); }


        .input-field { border-radius: 6px; border: 1px solid var(--border-color); padding: 0.7rem 1rem; width: 100%; transition: var(--transition-fluid); background-color: var(--main-bg); color: var(--text-headings); font-size: 0.95rem; }
        .input-field:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3); outline: none; }
        
        .card { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; padding: 1.75rem; position: relative; overflow: hidden; transition: var(--transition-fluid); }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: inherit; background: radial-gradient(500px circle at var(--mouse-x) var(--mouse-y), rgba(88, 166, 255, 0.2), transparent 80%); z-index: -1; opacity: 0; transition: opacity 0.4s ease-out; }
        .card:hover::before { opacity: 1; }
        .card-border { position: absolute; top:0; left:0; width:100%; height:100%; border-radius: inherit; border: 1px solid var(--border-color); z-index: 0; pointer-events: none; }

        .tab-container { display: inline-flex; gap: 0.5rem; padding: 0.3rem; background: rgba(22, 27, 34, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 8px; }
        .main-tab-button { padding: 0.5rem 1.5rem; border-radius: 6px; font-weight: 500; font-size: 0.9rem; transition: var(--transition-fluid); cursor: pointer; border: none; }
        .main-tab-button.active { background-color: var(--accent-color); color: var(--main-bg); font-weight: 600; box-shadow: 0 2px 8px -2px var(--accent-color); }
        .main-tab-button:not(.active) { background-color: transparent; color: var(--text-primary); }
        .main-tab-button:not(.active):hover { color: var(--text-white); }
        
        h1, h2, h3 { color: var(--text-headings); letter-spacing: -0.01em; }
        .text-positive { color: var(--positive-color); }
        .text-negative { color: var(--negative-color); }
        .hidden { display: none !important; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .alocar-card { background-color: rgba(22, 27, 34, 0.6); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--accent-color); box-shadow: 0 4px 20px rgba(82, 113, 255, 0.2); margin-top: 2rem; text-align: center; }
        .alocar-card-title { font-size: 1rem; font-weight: 700; color: var(--text-headings); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .alocar-card-value { font-size: 2.5rem; font-weight: 800; color: var(--accent-color); }
        
        .month-card { border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; text-align: center; cursor: pointer; transition: var(--transition-fluid); background: var(--card-bg); }
        .month-card:hover { transform: translateY(-4px); border-color: var(--accent-color); }
        .month-card.profit { border-left: 4px solid var(--positive-color); }
        .month-card.loss { border-left: 4px solid var(--negative-color); }
        .month-name { font-size: 1.125rem; font-weight: 600; color: var(--text-headings); }
        .month-result { font-size: 1.25rem; font-weight: 700; margin-top: 0.5rem; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--main-bg); border: 1px solid var(--border-color); padding: 2rem; border-radius: 0.5rem; max-width: 90%; width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: all 0.3s ease-in-out; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .highlight-card {
            border: 1px solid var(--negative-color);
            box-shadow: 0 0 25px -5px rgba(248, 81, 73, 0.4);
        }
        
        .important-note { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; background-color: rgba(210, 153, 34, 0.1); border-left: 4px solid var(--warning-color); }
        .important-note p:first-child { color: var(--warning-color); font-weight: 600;}
        .important-note p:last-child { color: var(--text-headings); opacity: 0.9;}

        #login-screen, #no-access-screen { background: var(--main-bg); display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000; }
        .login-box { text-align: center; width: 100%; max-width: 380px; animation: fadeInUp 0.5s var(--transition-fluid) both; }
        .message { margin-top: 1rem; font-weight: 500; display: none; padding: 0.8rem; border-radius: 6px; font-size: 0.9rem; }
        .message.error { color: #fff; background-color: rgba(248, 81, 73, 0.5); border: 1px solid rgba(248,81,73,0.8); }
        .message.success { color: #fff; background-color: rgba(63, 185, 80, 0.5); border: 1px solid rgba(63,185,80,0.8); }

        #auth-container { position: fixed; top: 1rem; right: 1rem; z-index: 1001; background: var(--card-bg); backdrop-filter: blur(10px); padding: 0.5rem 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 1rem; border: 1px solid var(--border-color); }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: var(--main-bg); z-index: 1999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: opacity 0.5s ease-out; }
        #animated-logo path { opacity: 0; animation: fadeInUp 0.7s ease-out forwards; }
        #animated-logo #logo-part-1 { animation-delay: 0.1s; } #animated-logo #logo-part-2 { animation-delay: 0.2s; } #animated-logo #logo-part-3 { animation-delay: 0.3s; } #animated-logo #logo-part-4 { animation-delay: 0.4s; } #animated-logo #logo-part-5 { animation-delay: 0.5s; } #animated-logo #logo-part-6 { animation-delay: 0.6s; } #animated-logo #logo-part-7 { animation-delay: 0.7s; } #animated-logo #logo-part-8 { animation-delay: 0.8s; }

        #tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9998; opacity: 0; transition: opacity 0.3s ease-out;
            pointer-events: none; background-color: transparent; backdrop-filter: none;
        }
        #tour-overlay.active { opacity: 1; pointer-events: all; }
        .tour-highlight { position: absolute; transition: var(--transition-fluid); border: 2px solid var(--accent-color); box-shadow: 0 0 25px 5px rgba(88, 166, 255, 0.6); border-radius: 8px; }
        .tour-tooltip { position: absolute; z-index: 9999; background: var(--card-bg); backdrop-filter: blur(12px); border-radius: 10px; border: 1px solid var(--border-color); width: 320px; padding: 1.5rem; animation: fadeInUp 0.4s var(--transition-fluid) both; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .tour-nav { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1rem;}

        /* ESTILOS PARA O MODAL DE TERMOS */
        #terms-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(13, 17, 23, 0.9); 
            backdrop-filter: blur(8px); 
            display: none; /* Inicia oculto */
            align-items: center; 
            justify-content: center; 
            z-index: 2500;
            transition: opacity 0.3s ease-in-out;
        }
        .terms-text-container {
            max-height: 55vh;
            overflow-y: auto;
            background-color: var(--main-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .terms-text-container p { margin-bottom: 1rem; }
        .terms-text-container strong { color: var(--text-headings); }
        .terms-text-container h4 { font-weight: 700; color: var(--accent-color); text-align: center; font-size: 1.2rem; margin-bottom: 1rem;}


        @media print {
            body, .content-wrapper, #printable-report-area, #pdf-export-cambial { background: #ffffff !important; color: #000000 !important; }
            body * { visibility: hidden; }
            #printable-report-area, #printable-report-area *, #pdf-export-cambial, #pdf-export-cambial * { visibility: visible; }
            #printable-report-area, #pdf-export-cambial { position: absolute; left: 0; top: 0; width: 100%; padding: 1rem; }
            .card { background-color: #f8f9fa !important; box-shadow: none; border: 1px solid #dee2e6; color: #000 !important; }
            h1, h2, h3, p, span, th, td { color: #000 !important; }
            .text-positive { color: #28a745 !important; }
            .text-negative { color: #dc3545 !important; }
            .text-accent-color { color: #007bff !important; }
            .month-card { page-break-inside: avoid; }
            #download-buttons-wrapper, #export-buttons, #open-tutorial-button, #auth-container, #cambial-download-buttons-wrapper { display: none !important; }
        }
    </style>
</head>
<body class="antialiased" style="overflow: hidden;">

    <div id="login-screen">
        <div class="login-box">
            <h2 class="text-3xl font-semibold mb-3 text-white">Plataforma XTributation</h2>
            <p class="text-base text-text-primary mb-8">Análise de performance e tributação.</p>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Seu e-mail" class="input-field">
                <input type="password" id="password-input" placeholder="Sua senha" class="input-field">
            </div>
            <button id="sign-in-button" class="mt-6 btn btn-primary w-full text-base py-3">
                <span>Acessar Plataforma</span>
            </button>
            <a href="#" id="forgot-password-link" class="text-sm text-text-primary hover:text-accent-color transition-colors duration-200 mt-6 inline-block">Problemas para acessar?</a>
            <p id="message" class="message"></p>
        </div>
    </div>

    <!-- Tela de acesso negado -->
    <div id="no-access-screen" style="display: none;">
        <div class="login-box">
            <h2 class="text-3xl font-semibold mb-3 text-white">Acesso Negado</h2>
            <p class="text-base text-text-primary mb-8">
                Não encontramos um pagamento ativo para esta conta. Por favor, verifique o status da sua compra ou entre em contato com o suporte.
            </p>
            <button id="logout-from-no-access" class="mt-6 btn btn-danger w-full text-base py-3">
                <span>Sair</span>
            </button>
        </div>
    </div>
    
    <div id="loading-overlay" style="display: none; opacity: 1;">
        <div class="text-center">
            <svg id="animated-logo" width="200" height="216" viewBox="0 0 841 1082" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#FFFFFF">
              <path id="logo-part-1" d="M 247.5 2 L 258.5 3 L 276.5 7 L 329.5 24 Q 389.9 45.6 446.5 71 L 524.5 110 L 556.5 130 L 581 150.5 L 589 161.5 Q 591.9 166.1 591 174.5 Q 584.3 208.8 560.5 226 Q 553.7 232.2 543.5 235 L 531.5 235 Q 518.7 232.3 512 223.5 Q 493.5 195 470.5 171 L 428.5 183 L 365.5 205 L 329.5 220 L 285.5 243 L 283 243 L 289.5 235 Q 305.3 221.3 324 210.5 Q 279.6 194.9 251 163.5 Q 241.7 152.8 236 138.5 L 232 123.5 L 231 103.5 L 235 82.5 L 238 74.5 L 240.5 72 L 244 74.5 Q 252 101.5 269.5 119 Q 293.7 143.8 328.5 158 L 357.5 168 L 392.5 176 L 404.5 177 L 428.5 170 L 463 163.5 Q 420 121.5 370.5 86 Q 316.4 46.1 254.5 14 L 245 5.5 Q 243.9 2.2 246.5 3 L 247.5 2 Z " />
              <path id="logo-part-2" d="M 236.5 269 L 237 272 Q 193.7 293.9 161 327.5 L 148 345.5 Q 144.2 352.2 144 362.5 Q 145.9 373.6 153.5 379 L 170.5 390 L 200.5 403 L 246.5 416 L 301.5 427 L 309 431.5 L 307.5 434 L 300.5 436 L 299.5 435 L 287.5 435 L 286.5 434 L 276.5 434 L 275.5 433 L 266.5 433 L 265.5 432 L 243.5 430 L 200.5 421 L 154.5 407 Q 143.8 403.2 138 394.5 L 128 374.5 L 126 366.5 L 126 347.5 Q 128.9 333.4 139.5 327 Q 183.4 294.2 236 271 L 236.5 269 Z " />
              <path id="logo-part-3" d="M 531.5 318 Q 572.9 344.6 605 380.5 Q 642.7 421.3 673 469.5 Q 703.5 517.5 728 571.5 Q 754 629 774 692.5 L 799 784.5 L 810 836.5 L 810 842 Q 813.7 840.6 812 846.5 L 819 880.5 L 819 886.5 L 822 899.5 L 822 905.5 L 823 906.5 L 826 933.5 L 828 941.5 L 828 948.5 L 829 949.5 L 829 956.5 L 830 957.5 L 830 965.5 L 831 966.5 L 832 983.5 L 833 984.5 L 833 992.5 L 835 1002.5 L 835 1011.5 L 837 1021.5 L 837 1030.5 L 838 1031.5 L 838 1040.5 L 839 1041.5 L 840 1062.5 L 841 1063.5 L 841 1079.5 L 839 1078.5 L 824 1007.5 L 812 957 Q 808.7 958.3 810 953.5 L 785 858.5 L 748 734.5 L 712 630.5 L 682 556.5 Q 650.8 483.7 611 419.5 L 577 370.5 Q 556.1 342.9 531 319.5 L 531.5 318 Z " />
              <path id="logo-part-4" d="M 369 446 Q 371.7 444.9 371 447.5 L 378 467.5 L 382 488.5 L 383 506.5 L 384 507.5 L 384 550.5 L 383 551.5 L 383 562.5 L 382 563.5 L 381 578.5 L 376 605.5 L 370 629.5 L 361 657.5 L 344 699.5 L 300 786.5 L 297.5 789 L 297 787.5 L 315 742.5 L 337 674.5 L 354 606.5 L 357 586.5 L 359 580.5 L 359 573.5 L 346 520.5 L 326 463.5 L 333 469.5 Q 353.1 494.9 365.5 528 L 367 524.5 L 368 501.5 L 369 500.5 L 370 451.5 L 369 446 Z " />
              <path id="logo-part-5" d="M 179.5 490 L 182 490.5 L 130.5 525 L 96.5 550 Q 64.7 573.7 38 602.5 L 37 621.5 Q 39.4 636.1 46 646.5 Q 56.6 663.4 71.5 676 Q 93.9 695.6 121.5 710 Q 145.4 678.4 174.5 652 Q 210.4 618.9 252.5 592 L 300.5 565 L 321.5 555 L 326.5 554 L 325.5 556 L 309.5 565 L 270.5 594 L 268.5 594 L 219 639.5 Q 149.1 711.1 103 806.5 L 77 883.5 L 58 958.5 L 58 963.5 L 53 987.5 L 53 994.5 L 51 1003.5 L 51 1013.5 L 50 1014.5 L 50 1030.5 L 49 1031.5 L 49 1078.5 L 47.5 1080 L 45 1071.5 L 45 1064.5 L 44 1063.5 L 44 1056.5 L 41 1039.5 L 41 1031.5 L 40 1030.5 L 40 1022.5 L 38 1013.5 L 38 1004.5 L 37 1003.5 L 36 975.5 L 35 974.5 L 35 942.5 L 36 941.5 L 37 914.5 L 38 913.5 L 38 906.5 L 39 905.5 L 42 881.5 L 47 859.5 L 56 829.5 L 71 791.5 Q 84.2 763.4 100 739 L 72.5 734 L 47.5 726 Q 25 717.5 10 701.5 L 1 685.5 L 0 681.5 L 0 662.5 L 9 638.5 Q 21.2 617.2 38 600.5 L 39 594.5 L 46 580.5 Q 57 563.5 72.5 551 Q 91.4 535.4 113.5 523 L 179.5 490 Z " />
              <path id="logo-part-6" d="M 632.5 775 L 640.5 775 L 641 776.5 L 593.5 800 L 577 810 L 575.5 813 Q 540.8 835.3 514 865.5 Q 474 909 448 966.5 L 429 1017.5 L 418.5 1057 L 418 1053.5 L 419 1052.5 L 419 1045.5 L 425 1012.5 L 433 979.5 L 442 949.5 L 458 908.5 Q 471.2 878.7 489 853.5 Q 502 835 518.5 820 L 529 811.5 L 530.5 809 Q 546.3 796.8 566.5 789 L 586.5 783 L 591.5 783 L 632.5 775 Z " />
              <path id="logo-part-7" d="M 338.5 820 Q 341.1 819.2 340 822.5 L 329.5 831 L 259.5 877 Q 231.5 896 209 920.5 Q 173.9 958.9 144 1002.5 Q 127 1026.5 116.5 1057 L 116 1052.5 L 126 1012.5 Q 135.2 986.2 148 963.5 Q 171.4 922.4 205.5 892 Q 232.8 867.8 266.5 850 L 316.5 828 L 338.5 820 Z " />
              <path id="logo-part-8" d="M 361.5 824 L 363 826.5 L 348 902.5 L 347 918.5 L 346 919.5 L 346 948.5 L 347 949.5 L 347 962.5 L 348 963.5 L 349 982.5 L 350 983.5 L 350 990.5 L 351 991.5 L 354 1015.5 L 363 1047.5 L 368 1056.5 L 366 1057 Q 347.3 1031.3 337 996.5 L 333 980.5 L 331 961.5 L 330 960.5 L 330 920.5 L 331 919.5 L 331 912.5 L 334 895.5 L 339 876.5 L 354 837.5 L 359 826.5 L 361.5 824 Z " />
            </svg>
            <p id="loading-message" class="text-text-primary mt-4">Carregando plataforma...</p>
        </div>
    </div>
    
    <div id="auth-container" style="display: none;">
        <span id="user-email" class="text-white text-sm font-medium"></span>
        <button id="sign-out-button" class="text-xs text-negative-color hover:text-white transition-colors">Sair</button>
    </div>

    <!-- O conteúdo da calculadora permanece o mesmo -->
    <div id="calculator-content" style="display: none;">
        <div class="content-wrapper">
            <header class="mb-12 flex justify-between items-center relative stagger-in" style="--stagger-index: 0;">
                <div class="flex items-center gap-4">
                    <svg width="40" height="40" viewBox="0 0 841 1082" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#C9D1D9">
                        <path d="M 247.5 2 L 258.5 3 L 276.5 7 L 329.5 24 Q 389.9 45.6 446.5 71 L 524.5 110 L 556.5 130 L 581 150.5 L 589 161.5 Q 591.9 166.1 591 174.5 Q 584.3 208.8 560.5 226 Q 553.7 232.2 543.5 235 L 531.5 235 Q 518.7 232.3 512 223.5 Q 493.5 195 470.5 171 L 428.5 183 L 365.5 205 L 329.5 220 L 285.5 243 L 283 243 L 289.5 235 Q 305.3 221.3 324 210.5 Q 279.6 194.9 251 163.5 Q 241.7 152.8 236 138.5 L 232 123.5 L 231 103.5 L 235 82.5 L 238 74.5 L 240.5 72 L 244 74.5 Q 252 101.5 269.5 119 Q 293.7 143.8 328.5 158 L 357.5 168 L 392.5 176 L 404.5 177 L 428.5 170 L 463 163.5 Q 420 121.5 370.5 86 Q 316.4 46.1 254.5 14 L 245 5.5 Q 243.9 2.2 246.5 3 L 247.5 2 Z M 236.5 269 L 237 272 Q 193.7 293.9 161 327.5 L 148 345.5 Q 144.2 352.2 144 362.5 Q 145.9 373.6 153.5 379 L 170.5 390 L 200.5 403 L 246.5 416 L 301.5 427 L 309 431.5 L 307.5 434 L 300.5 436 L 299.5 435 L 287.5 435 L 286.5 434 L 276.5 434 L 275.5 433 L 266.5 433 L 265.5 432 L 243.5 430 L 200.5 421 L 154.5 407 Q 143.8 403.2 138 394.5 L 128 374.5 L 126 366.5 L 126 347.5 Q 128.9 333.4 139.5 327 Q 183.4 294.2 236 271 L 236.5 269 Z M 531.5 318 Q 572.9 344.6 605 380.5 Q 642.7 421.3 673 469.5 Q 703.5 517.5 728 571.5 Q 754 629 774 692.5 L 799 784.5 L 810 836.5 L 810 842 Q 813.7 840.6 812 846.5 L 819 880.5 L 819 886.5 L 822 899.5 L 822 905.5 L 823 906.5 L 826 933.5 L 828 941.5 L 828 948.5 L 829 949.5 L 829 956.5 L 830 957.5 L 830 965.5 L 831 966.5 L 832 983.5 L 833 984.5 L 833 992.5 L 835 1002.5 L 835 1011.5 L 837 1021.5 L 837 1030.5 L 838 1031.5 L 838 1040.5 L 839 1041.5 L 840 1062.5 L 841 1063.5 L 841 1079.5 L 839 1078.5 L 824 1007.5 L 812 957 Q 808.7 958.3 810 953.5 L 785 858.5 L 748 734.5 L 712 630.5 L 682 556.5 Q 650.8 483.7 611 419.5 L 577 370.5 Q 556.1 342.9 531 319.5 L 531.5 318 Z M 369 446 Q 371.7 444.9 371 447.5 L 378 467.5 L 382 488.5 L 383 506.5 L 384 507.5 L 384 550.5 L 383 551.5 L 383 562.5 L 382 563.5 L 381 578.5 L 376 605.5 L 370 629.5 L 361 657.5 L 344 699.5 L 300 786.5 L 297.5 789 L 297 787.5 L 315 742.5 L 337 674.5 L 354 606.5 L 357 586.5 L 359 580.5 L 359 573.5 L 346 520.5 L 326 463.5 L 333 469.5 Q 353.1 494.9 365.5 528 L 367 524.5 L 368 501.5 L 369 500.5 L 370 451.5 L 369 446 Z M 179.5 490 L 182 490.5 L 130.5 525 L 96.5 550 Q 64.7 573.7 38 602.5 L 37 621.5 Q 39.4 636.1 46 646.5 Q 56.6 663.4 71.5 676 Q 93.9 695.6 121.5 710 Q 145.4 678.4 174.5 652 Q 210.4 618.9 252.5 592 L 300.5 565 L 321.5 555 L 326.5 554 L 325.5 556 L 309.5 565 L 270.5 594 L 268.5 594 L 219 639.5 Q 149.1 711.1 103 806.5 L 77 883.5 L 58 958.5 L 58 963.5 L 53 987.5 L 53 994.5 L 51 1003.5 L 51 1013.5 L 50 1014.5 L 50 1030.5 L 49 1031.5 L 49 1078.5 L 47.5 1080 L 45 1071.5 L 45 1064.5 L 44 1063.5 L 44 1056.5 L 41 1039.5 L 41 1031.5 L 40 1030.5 L 40 1022.5 L 38 1013.5 L 38 1004.5 L 37 1003.5 L 36 975.5 L 35 974.5 L 35 942.5 L 36 941.5 L 37 914.5 L 38 913.5 L 38 906.5 L 39 905.5 L 42 881.5 L 47 859.5 L 56 829.5 L 71 791.5 Q 84.2 763.4 100 739 L 72.5 734 L 47.5 726 Q 25 717.5 10 701.5 L 1 685.5 L 0 681.5 L 0 662.5 L 9 638.5 Q 21.2 617.2 38 600.5 L 39 594.5 L 46 580.5 Q 57 563.5 72.5 551 Q 91.4 535.4 113.5 523 L 179.5 490 Z M 632.5 775 L 640.5 775 L 641 776.5 L 593.5 800 L 577 810 L 575.5 813 Q 540.8 835.3 514 865.5 Q 474 909 448 966.5 L 429 1017.5 L 418.5 1057 L 418 1053.5 L 419 1052.5 L 419 1045.5 L 425 1012.5 L 433 979.5 L 442 949.5 L 458 908.5 Q 471.2 878.7 489 853.5 Q 502 835 518.5 820 L 529 811.5 L 530.5 809 Q 546.3 796.8 566.5 789 L 586.5 783 L 591.5 783 L 632.5 775 Z M 338.5 820 Q 341.1 819.2 340 822.5 L 329.5 831 L 259.5 877 Q 231.5 896 209 920.5 Q 173.9 958.9 144 1002.5 Q 127 1026.5 116.5 1057 L 116 1052.5 L 126 1012.5 Q 135.2 986.2 148 963.5 Q 171.4 922.4 205.5 892 Q 232.8 867.8 266.5 850 L 316.5 828 L 338.5 820 Z M 361.5 824 L 363 826.5 L 348 902.5 L 347 918.5 L 346 919.5 L 346 948.5 L 347 949.5 L 347 962.5 L 348 963.5 L 349 982.5 L 350 983.5 L 350 990.5 L 351 991.5 L 354 1015.5 L 363 1047.5 L 368 1056.5 L 366 1057 Q 347.3 1031.3 337 996.5 L 333 980.5 L 331 961.5 L 330 960.5 L 330 920.5 L 331 919.5 L 331 912.5 L 334 895.5 L 339 876.5 L 354 837.5 L 359 826.5 L 361.5 824 Z " />
                    </svg>
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tighter">XTributation</h1>
                        <p class="text-base text-text-primary">Plataforma de Imposto de Renda XTraders</p>
                    </div>
                </div>
                <button id="open-tutorial-button" class="btn btn-secondary !p-2.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
            </header>
            
            <div class="flex justify-center mb-12 stagger-in" style="--stagger-index: 1;">
                <div id="tour-step-1" class="tab-container">
                    <button id="main-tab-cambial" onclick="showMainTab('cambial')" class="main-tab-button active">Envios e Retiradas</button>
                    <button id="main-tab-ir" onclick="showMainTab('ir')" class="main-tab-button">Apuração Anual de IR</button>
                </div>
            </div>

            <div id="main-content-cambial" class="main-content">
                <div id="cambial-input-area" class="space-y-6">
                    <div id="tour-step-2" class="card">
                        <div class="card-border"></div>
                        <h3 class="text-lg font-semibold mb-4 text-white">Adicione um Registro</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label class="block text-xs font-medium mb-1">Data</label><input type="date" id="trans-date" class="input-field"></div>
                            <div><label class="block text-xs font-medium mb-1">Tipo</label><select id="trans-type" class="input-field"><option value="Envio">Envio</option><option value="Retirada">Retirada</option><option value="Não Retirada" id="nao-retirada-option" disabled>Não Retirada</option></select></div>
                            <div><label class="block text-xs font-medium mb-1">Valor Líquido (USD)</label><input type="text" id="trans-value" placeholder="1.000,00" class="input-field"></div>
                            <div class="flex gap-2">
                                <button id="add-trans-button" onclick="handleSaveTransaction()" class="btn btn-secondary w-full">Adicionar +</button>
                                <button id="cancel-edit-button" onclick="cancelEdit()" class="btn btn-secondary w-full hidden" style="border-color: var(--warning-color); color: var(--warning-color);">Cancelar</button>
                            </div>
                        </div>
                        <div class="important-note">
                            <p>MUITO IMPORTANTE:</p>
                            <p class="mt-1 text-sm">NÃO CONSIDERAR OU INFORMAR RETIRADAS DE LUCRO COM OS SEUS TRADES NESTE CAMPO. AQUI DEVE-SE INFORMAR SOMENTE O CAPITAL ORIGINALMENTE ENVIADO OU RETIRADO DO EXTERIOR (MARGEM PARA OPERAR).</p>
                        </div>
                        <div id="transactions-list" class="mt-6"></div>
                    </div>
                    <div id="tour-step-3" class="card">
                        <div class="card-border"></div>
                        <h3 class="text-lg font-semibold mb-3 text-white">Cotações do Dólar (Obrigatório)</h3>
                        <p class="text-sm mb-4">Carregue o arquivo CSV que contém os dados de cotação de compra e venda do dólar, conforme orientado nas aulas.</p>
                        <div>
                             <label class="block text-xs font-medium mb-1" for="rates-file-unified" id="rates-file-unified-label">Arquivo de Cotações Unificado (.csv)</label>
                             <input type="file" id="rates-file-unified" accept=".csv" class="input-field">
                        </div>
                    </div>
                    <div id="tour-step-4" class="text-center pt-4">
                        <button onclick="handleProcessCambial()" class="btn btn-primary text-lg px-12 py-3">
                            <span>Processar Dados</span>
                        </button>
                    </div>
                     <div id="alocar-proximo-ano-card" class="alocar-card hidden">
                         <div class="alocar-card-title">ALOCAR PARA O PRÓXIMO ANO</div>
                         <div id="alocar-proximo-ano-valor" class="alocar-card-value">R$ 0,00</div>
                     </div>
                </div>
                <div id="results-area-cambial" class="transition-opacity duration-500 mt-12"></div>
            </div>
            
            <div id="main-content-ir" class="main-content hidden">
                <div id="tour-step-5" class="card stagger-in">
                    <div class="card-border"></div>
                    <h2 class="text-xl font-semibold mb-6 text-white text-center">Apuração de Imposto de Renda Anual</h2>
                    <p class="text-center text-sm mb-6 -mt-4">O cálculo do imposto é consolidado e apurado anualmente.</p>
                    <div id="alert-box" class="hidden p-4 mb-6 text-sm rounded-lg bg-yellow-900 text-yellow-300 border border-yellow-700" role="alert"></div>
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <label for="trades-file" class="w-full flex flex-col justify-center items-center p-6 border-2 border-dashed border-border-color rounded-lg cursor-pointer hover:border-accent-color transition-colors">
                            <svg class="mx-auto h-12 w-12 text-text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <span id="trades-file-name" class="mt-2 text-sm font-semibold text-text-headings">Relatório de Operações (.csv)</span>
                        </label>
                        <input type="file" id="trades-file" accept=".csv" class="hidden"/>
    
                        <label for="quotes-file" class="w-full flex flex-col justify-center items-center p-6 border-2 border-dashed border-border-color rounded-lg cursor-pointer hover:border-accent-color transition-colors">
                            <svg class="mx-auto h-12 w-12 text-text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <span id="quotes-file-name" class="mt-2 text-sm font-semibold text-text-headings">Planilha de Cotações (.csv)</span>
                        </label>
                        <input type="file" id="quotes-file" accept=".csv" class="hidden"/>
                    </div>
                    <button id="process-button" class="btn btn-primary w-full text-base py-3">
                        <span id="button-text">Apurar Impostos</span>
                        <div id="loader" class="loader !w-6 !h-6 hidden ml-3"></div>
                    </button>
                </div>
    
                <div id="results" class="hidden mt-12 stagger-in">
                    <div id="printable-report-area">
                        <div id="success-box" class="p-4 mb-4 text-sm rounded-lg bg-green-900 text-green-300 border border-green-700"></div>
                        <h2 class="text-2xl font-bold mb-6">📊 Resultados da Apuração</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="card"><p class="text-sm font-medium text-text-primary">Resultado Líquido (USD)</p><p id="total-usd" class="text-2xl font-bold text-white mt-1"></p></div>
                            <div class="card"><p class="text-sm font-medium text-text-primary">Resultado Líquido (BRL)</p><p id="total-brl" class="text-2xl font-bold text-white mt-1"></p></div>
                        </div>
                        <div class="card highlight-card text-center p-8 mb-8">
                            <p class="text-base font-medium text-text-primary uppercase tracking-wider">Imposto Anual Devido (DARF)</p>
                            <p id="total-tax" class="text-5xl font-extrabold text-negative mt-2"></p>
                        </div>
                        
                        <div class="card text-center p-6 mb-8" style="border-left: 4px solid var(--positive-color);">
                            <p class="text-base font-medium text-text-primary uppercase tracking-wider">Resultado Anual Após Pagamento da DARF</p>
                            <p id="total-after-tax" class="text-4xl font-bold text-white mt-2"></p>
                        </div>

                        <div class="card mb-8">
                            <div class="card-border"></div>
                            <h3 class="text-lg font-semibold mb-4 text-white">Desempenho Mensal (BRL)</h3>
                            <div class="h-80">
                                <canvas id="monthly-performance-chart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-border"></div>
                            <h3 class="text-lg font-semibold mb-4 text-white">Calendário Anual de Resultados</h3>
                            <p class="text-sm mb-6">Clique em um mês para ver o detalhe das operações.</p>
                            <div id="calendar-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                    <div id="download-buttons-wrapper" class="flex flex-col sm:flex-row gap-4 mt-8">
                        <button id="export-pdf-button" class="btn btn-secondary w-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>Exportar Relatório (PDF)</span>
                        </button>
                        <button id="export-xls-button" class="btn btn-secondary w-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Exportar para Excel (.csv)</span>
                        </button>
                    </div>
                </div>
            </div>
    
        </div>
    </div>

    <div id="trades-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-white"></h2>
                <button id="close-modal-button" class="text-2xl text-text-primary hover:text-white transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[60vh] rounded-lg border border-border-color">
                <table class="min-w-full divide-y divide-border-color">
                    <thead class="bg-card-bg">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-primary uppercase tracking-wider">Data</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-primary uppercase tracking-wider">Ativo</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-text-primary uppercase tracking-wider">Resultado (USD)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-text-primary uppercase tracking-wider">Resultado (BRL)</th>
                        </tr>
                    </thead>
                    <tbody id="modal-table-body" class="divide-y divide-border-color"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="tour-overlay" style="display: none;">
        <div class="tour-highlight"></div>
        <div class="tour-tooltip">
             <h3 id="tour-title" class="text-xl font-bold mb-2 text-white"></h3>
             <p id="tour-text" class="text-base mb-4 text-text-primary"></p>
             <div class="tour-nav">
                 <button id="tour-skip-btn" class="text-sm text-text-primary hover:text-white">Pular</button>
                 <div class="flex items-center gap-3">
                     <span id="tour-step-counter" class="text-sm text-text-primary"></span>
                     <button id="tour-prev-btn" class="btn btn-secondary !py-1.5 !px-3 !text-xs">Anterior</button>
                     <button id="tour-next-btn" class="btn btn-primary !py-1.5 !px-3 !text-xs">Próximo</button>
                 </div>
             </div>
        </div>
    </div>

    <div id="terms-modal-overlay">
        <div class="modal-content !w-[900px]">
            <div class="terms-text-container">
                <h4>&gt;&gt; Termos Legais, Condições e Avisos &lt;&lt;</h4>
                <p>Ao utilizar as planilhas, ferramentas, e ao fazer uso das informações contidas no projeto IR, o usuário confirma que leu, entendeu e aceitou os termos, condições e avisos aqui listados.</p>
                <p><strong>1 -</strong> As planilhas, ferramentas e informações contidas no Projeto IR são preparadas para operações em Forex, Ouro, índices diversos e demais ativos, operados através de CFDs (Contracts for Difference) por corretoras de varejo diversas. As informações dos relatórios devem ser incluídas corretamente nos devidos campos, conforme tutoriais passados ao cliente; doravante todo o projeto, ferramentas, planilhas e informações serão tratados como "Projeto IR" nesses termos; o cliente que adquire a licença para uso das planilhas, ferramentas e informações contidas no Projeto IR, pode ser tratado aqui como "contribuinte", "cliente", "usuário" ou qualquer termo que assim o identifique.</p>
                <p><strong>2 -</strong> As planilhas, ferramentas e informações contidas no Projeto IR não são recomendações de investimentos, nem de onde aplicar qualquer tipo de capital. Todo o conteúdo nessa mídia é apenas em caráter educacional, e nenhum conteúdo aqui nesse meio é recomendação de investimento, ou indicação para aplicações em quaisquer instrumentos financeiros. Todo conteúdo publicado aqui baseia-se no direito de expressão garantido nos arts. 5°, IV e 220 da Constituição Federal de 1988. Este site representa apenas opiniões e decisões pessoais, que podem não ser apropriadas para outros investidores. Por favor, use o bom senso e/ou consulte um profissional de investimento certificado antes de investir seu dinheiro. O Eu Sou Trader Investidor e os seus criadores não são responsáveis pelos resultados de suas decisões, nem responsáveis pelos comentários postados por leitores ou pelo conteúdo de quaisquer sites vinculados. Este site deve ser visualizado apenas para fins educacionais ou de entretenimento. Resultado passado não é garantia de resultado futuro. Forex e qualquer tipo de CFDs são de alto risco, onde a alta alavancagem pode fazer o trader ter grandes perdas. Por isso sempre aja consciente, tomando as suas decisões com base unicamente no que você pensa e decide por conta e risco próprios. Caso deseje informações sobre onde aplicar seu dinheiro, busque ajuda de pessoas que sejam autorizadas para tal. Dessa forma, seguimos todas as orientações da CVM e demais órgãos responsáveis pela regulação e legislação dos mercados financeiros no Brasil. A língua utilizada na divulgação do conteúdo nessa mídia é o português, que é o idioma falado por quem apresenta o conteúdo, mas NÃO é uma indicação de que esse conteúdo e qualquer material aqui presente se destine a brasileiros. Se você é residente no Brasil, por favor, entenda que esse conteúdo e material aqui presente não se destina a brasileiros. Qualquer contato ou resposta, qualquer menção a elementos que o levem a crer que o conteúdo se destina a residentes no Brasil não deve ser interpretado como sendo uma oferta pública de ativos mobiliários a brasileiros.</p>
                <p><strong>3 -</strong> As ferramentas contidas no projeto, quando utilizadas em formas de planilhas, estão disponibilizadas apenas para o programa Excel, da Microsoft, não estando disponíveis para outros programas, como, por exemplo o Google Planilhas, Calc da Libre Office, entre outros. O cliente entende e aceita que poderá acessar as ferramentas no programa Excel, que é o sistema para o qual as ferramentas foram desenvolvidas. Qualquer tentativa de utilização em outros programas ficará suscetível a erros, e podem não fazer apurações adequadamente. O cliente não poderá exigir que a ferramenta seja adaptada para outros programas, e precisará utilizá-las apenas no Excel. O programa de planilhas da Microsoft foi o único que a equipe do Eu Sou Trader Investidor conseguiu incluir fórmulas de cálculo específicas para que a apuração pudesse ser realizada, já que outros programas infelizmente têm limitações que impossibilitam o cálculo automático específico, da forma como o Excel faz muito bem.</p>
                <p><strong>4 -</strong> A forma de utilização das ferramentas deve seguir estritamente como está orientado nos vídeos tutoriais, e na ocorrência de qualquer problema envolvendo o correto preenchimento, o cliente deve buscar as informações nas explicações em vídeos ou textos presentes no projeto. Em caso de outras dúvidas, a equipe Eu Sou Trader Investidor disponibiliza canais de atendimento para tentativa de solução, através de e-mail e um grupo exclusivo de Whatsapp, cujo link para acesso está dentro da área de membros do projeto.</p>
                <p><strong>5 -</strong> Em relação à aquisição da licença para uso das informações, planilhas e ferramentas contidas no Projeto IR, o cliente poderá usufruir do benefício pleno do art. 49, da lei n. 8.078/90.</p>
                <p><strong>6 -</strong> Estas planilhas, ferramentas e informações contidas no projeto foram elaboradas conforme legislação vigente brasileira até 2023/2024/2025, data da aquisição. Porém, devido à falta de maiores detalhes por parte da Receita Federal para investimentos em CFDs no exterior, as informações geradas pelas planilhas, ferramentas e informações contidos no Projeto IR não garantem a não posterior verificação pela Receita Federal, que tem o poder e direito legal de questionar o contribuinte.</p>
                <p><strong>7 -</strong> As planilhas, ferramentas e informações contidas no projeto ajudam a verificar a existência ou não da isenção do IR, que era plena e sem dúvidas para operações encerradas até o final de 2023. Para os trades e operações de investimentos em aplicações financeiras no exterior a partir de 2024, de acordo com a nova lei 14.754/2023, especialmente após a interpretação da Receita Federal através da Solução de Consulta Cosit n° 83, de 09 de abril de 2024, a isenção não mais se aplica. Assim, todo e qualquer lucro em Aplicações Financeiras no Exterior será tributado, e deve ser pago após apuração feita anualmente. Assim, ao usar as planilhas, ferramentas e informações contidas no projeto, o cliente está ciente de que para trades/negociações encerrados até o final de 2023, ele poderia usufruir plenamente do benefício legal da isenção, previsto no inciso Il, do art. 22, da lei 9250/1995; podendo usar as ferramentas e informações disponíveis para essa verificação, e prestação das informações corretas para a Receita Federal nas declarações anuais até a de 2024. Para a declaração anual a partir de 2025, referente aos trades/negociações encerrados em 2024, está claro pela interpretação da Receita Federal que a isenção não mais se aplica. A nova lei 14.754/2023, que estabelece regras atualizadas para apuração de imposto de renda de aplicações financeiras no exterior, não se aplica aos trades/negociações encerrados até 31/12/2023, que devem ser apurados pela legislação anterior. Assim, as planilhas, ferramentas e informações contidas no Projeto IR estão totalmente em conformidade a como o assunto era tratado até o último dia de 2023.</p>
                <p><strong>8 -</strong> Toda e qualquer decisão que o cliente tomar em relação à suas finanças e seu imposto de renda é de sua única e exclusiva responsabilidade, que deve estar ciente de como funciona o processo de apuração do IR. As planilhas, ferramentas e informações contidas no Projeto IR o ajudarão a entender o processo de tributação, mas não vinculam nenhuma decisão do cliente, que deve seguir o que estabelecer por conta própria como atitude a ser tomada, e mantendo sua responsabilidade exclusiva pelas informações prestadas à Receita Federal. A equipe do Eu Sou Trader Investidor não se responsabiliza por qualquer decisão que o cliente tomar ao declarar/pagar/não pagar seu imposto de renda. O cliente está ciente de que não responsabilizará os criadores do material do Projeto IR, entendendo que qualquer decisão tomada é de sua inteira responsabilidade, e que todas as informações contidas no projeto são apenas de caráter educacional e geral. Todo o material do Projeto IR baseia-se no direito de expressão garantido nos arts. 5°, IV e 220 da Constituição Federal de 1988, e cabe unicamente ao cliente decidir o que fazer e como proceder, tendo as informações do Projeto IR apenas em caráter de informação, não de obrigação legal. O cliente entende que as planilhas, ferramentas e informações contidas no Projeto IR são apenas informativas, e não geram a obrigação legal de tomar qualquer atitude referente a seus impostos e declaração; ou seja, o que o contribuinte decidir fazer após a informação dadas pelas planilhas, ferramentas e informações contidas no Projeto IR é de sua inteira responsabilidade.</p>
                <p><strong>9 -</strong> Qualquer questionamento posterior da Receita Federal deve ser lidado pelo próprio contribuinte. A empresa fornecedora Eu Sou Trader Investidor e seus integrantes poderão auxiliar em questões futuras, com o fornecimento de informações para o cliente, sem, entretanto, ter obrigações legais nesse sentido, nem obrigação legal de prestar assistência especializada. Caso esse questionamento ocorra, o cliente venha a estar em "malha fina", ou mesmo tenha sido autuado pela Receita Federal, ele entende que toda informação prestada é de sua inteira responsabilidade, e que a empresa e a equipe do Eu Sou Trader Investidor não poderá ser responsabilziada, uma vez que todo o conteúdo nas planilhas, ferramentas e informações contidas no Projeto IR é apenas, e unicamente, informativo e educacional, e não uma vinculação legal ao que o usuário deva ou não fazer em relação a suas obrigações fiscais. Em caso de fiscalização, malha fina, multa, ou qualquer tipo de questionamento da Receita Federal, o usuário deve procurar auxílio especializado de profissionais que atuam area, devidamente autorizados para esse fim, como contadores e advogados tributaristas.</p>
                <p><strong>10 -</strong> Para os casos de isenção plena, de acordo com o item 7 desses Termos Legais, as planilhas, ferramentas e informações contidas no Projeto IR também ajudam o cliente a verificar se ha/havia imposto a pagar; elas ajudam no calculo através de uma forma simplificada, evitando o registro de centenas e milhares de trades um a um no GCAP, o que seria inviavel. Se as planilhas, ferramentas e informações contidas no projeto informarem uma situação de isenção, de acordo com o item 7 desses termos, o usuário precisa estar plenamente convicto de que pode apenas informar seus ganhos isentos na declaração anual; e se os materiais e informações do Projeto IR mostrarem uma situação de não isenção, o usuário precisa estar plenamente convicto e decidido sobre que ações tomar; Na situação de não isenção, de acordo com o item 7 desses termos, o imposto pode ser tanto calculado sobre o ganho de capital bruto das operações ou o líquido, dependendo do período em que as operações foram encerradas. Para trades/negociações encerrados até o final de 2023, o imposto era aplicado sobre o lucro bruto, que é a situação legal já explicada pela Receita Federal através da Solução de Consulta n° 4 - Cosit, data 6 de janeiro de 2014. Para os trades encerrados a partir de 2024, o imposto é calculado sobre o lucro líquido, de acordo com a previsão legal da lei 14.754/2023, no art. 9º e paragrafos.</p>
                <p><strong>11 -</strong> O usuário das planilhas, ferramentas e informações contidas no projeto IR entende que precisará completar as cotações dos pares de referência e do USDBRL nos locais correspondentes, para correta apuração dos dados a partir da última data com registros atualizados. Porém, tendo adquirido o produto completo específico, poderá baixar sem custos extras, à titulo de 'brinde', mensalmente, um modelo atualizado, com as cotações já preenchidas, e precisará apenas copiar e colar, seguindo o passo a passo explicado nos tutoriais respectivos, tudo em conformidade com os termos e condições aqui descritos. A atualização das planilhas, ferramentas e informações contidas no Projeto IR com as cotações não é uma garantia, apenas um bônus para o cliente, e somente caso estejam disponíveis. Independente disso, as ferramentas funcionam normalmente, desde que as cotações sejam atualizadas</p>
                <p><strong>12 -</strong> Caso a planilha, ferramentas e informações contidas no Projeto IR contenham informações de corretoras, essas empresas não têm qualquer responsabilidade com o conteúdo do material, estando o seu nome citado apenas para fins de identificação com a ordem dos dados emitidos pelos relatórios das plataformas, e para o adequado ajuste dos ativos e suas especificações, como alavancagem máxima, valor do contrato, fator de multiplicação, cálculo da margem, moeda negociada, entre outros, que são conseguidos nos sites das corretoras ou em condio como sudore.</p>
                <p><strong>13 -</strong> Quando as planilhas, ferramentas e informações contidas no Projeto IR previrem o abatimento de Outros Descontos Considerados, esses são os custos que o contribuinte entende como de devido abatimento do ganho de capital, para diminuição da base de cálculo, e consequente redução do IR a pagar. A base para esse entendimento é decidida pelo utilizador das planilhas, ferramentas e informações contidas no projeto IR, e considerada, por sua decisão, como adequada para esse abatimento. A recomendação é que se considere apenas custos operacionais diretamente ligados as operações com os ativos preenchidos nos locais adequados.</p>
                <p><strong>14 -</strong> Após Solução de Consulta Cosit n° 282, de 09 de novembro de 2023, em que a Receita Federal entendeu que os CFDs no exterior têm custo de aquisição zero, não é mais necessário calcular a margem das operações. Todas as operações incluídas na planilha consideram apenas o resultado e as despesas envolvidas, ou informadas, e a data de fechamento das negociações, para apuração. Dúvidas podem ser tiradas diretamente com a equipe do Eu Sou Trader Investidor, de acordo com o item 4 desses Termos Legais.</p>
                <p><strong>15 -</strong> Na hipótese de as planilhas, ferramentas e informações contidas no Projeto IR permitirem a informação de "Base de Cálculo a Tributar em REAIS", significa que esse campo é destinado a situações em que o cliente considere justo outro valor a ser tributado. As ferramentas mostrarão o ganho tributável na parte da Apuração, mas o usuário pode definir, por decisão própria, como descrito no item 8 desses Termos Legais, uma outra base de cálculo a tributar, um valor diverso do que for mostrado na parte de Apuração; com esse preenchimento, as ferramentas mostrarão em "Valores Descontados" informações que se colocadas nos programas da Receita Federal, o imposto será calculado em cima dessa nova base de cálculo, e não da base de cálculo original informada na Apuração. Se o usuário utilizar esse campo, deve decidir por conta própria a base de cálculo que considera justa sofrer tributação, embora a nossa recomendação seja seguir estritamente o que há na legislação tributária aplicável.</p>
                <p><strong>16 -</strong> O usuário das planilhas, ferramentas e informações contidas no Projeto IR entende que precisa ficar atento aos prazos de vencimento para pagamento das DARFs, se existirem de acordo com a apuração, conforme item 7 desses Termos Legais. O vencimento para pagamento do imposto, dependendo do ano em que as operações foram encerradas pode ser tanto no último dia útil do mês seguinte ao que as operações foram realizadas (até final de 2023), ou pelo prazo estipulado pela Receita Federal, após alterações pela lei 14.754/2023 (a partir de 2024). Caso haja feriados ou finais de semana, é de inteira responsabilidade do cliente essa verificação, e os criadores do Projeto IR e equipe do Eu Sou Trader Investidor não se responsabilizam por lembrar o cliente da data limite para pagamento. O atraso no pagamento do imposto gera multa e juros pela Receita Federal.</p>
                <p><strong>17 -</strong> Qualquer cliente que esteja tendo dificuldades com a apuração nas planilhas, ferramentas e informações contidas no Projeto IR poderá solicitar auxílio da equipe responsável, que providenciará a resposta adequada, se possível, com a maior brevidade possível dentro do razoável. Caso o cliente, mesmo após a ajuda, não consiga apurar seu imposto corretamente.</p>
            </div>
            <div class="flex justify-end items-center gap-4 mt-auto pt-6 border-t border-border-color">
                <button id="decline-terms-btn" class="btn btn-danger">Recusar e Sair</button>
                <button id="accept-terms-btn" class="btn btn-primary">Li, entendi e aceito os termos</button>
            </div>
        </div>
    </div>
    <script type="module">
        // --- INICIALIZAÇÃO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB9yJzA2imAFsUjYGF7S7HzTA3kPNf6P7o",
          authDomain: "calculadora-ir-56a2c.firebaseapp.com",
          projectId: "calculadora-ir-56a2c",
          storageBucket: "calculadora-ir-56a2c.appspot.com",
          messagingSenderId: "613402077853",
          appId: "1:613402077853:web:244d838cc2a99452288274"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const noAccessScreen = document.getElementById('no-access-screen');
        const logoutFromNoAccessBtn = document.getElementById('logout-from-no-access');
        const calculatorContent = document.getElementById('calculator-content');
        const authContainer = document.getElementById('auth-container');
        const userEmailDisplay = document.getElementById('user-email');
        const signOutButton = document.getElementById('sign-out-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const signInButton = document.getElementById('sign-in-button');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const messageElement = document.getElementById('message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const termsModal = document.getElementById('terms-modal-overlay');
        const acceptTermsBtn = document.getElementById('accept-terms-btn');
        const declineTermsBtn = document.getElementById('decline-terms-btn');
        
        // --- LÓGICA DE AUTENTICAÇÃO E VERIFICAÇÃO ---

        async function checkUserPaymentStatus(user) {
            if (!user) return false;
            const paymentsRef = collection(db, "payments");
            const q = query(paymentsRef, 
                where("buyerEmail", "==", user.email), 
                where("status", "==", "paid")
            );
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    console.log("Pagamento ativo encontrado para o usuário:", user.email);
                    return true; 
                } else {
                    console.log("Nenhum pagamento ativo encontrado para o usuário:", user.email);
                    return false;
                }
            } catch (error) {
                console.error("Erro ao verificar o status do pagamento:", error);
                return false;
            }
        }

        function showMainApplication() {
            loadingMessage.textContent = 'Carregando plataforma...';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                loadingOverlay.addEventListener('transitionend', () => {
                    loadingOverlay.style.display = 'none';
                }, { once: true });

                calculatorContent.style.display = 'block';
                authContainer.style.display = 'flex';
                document.body.style.overflow = 'auto';

                if (!localStorage.getItem('xtributationTutorialSeen')) {
                    setTimeout(startTour, 700);
                }
            }, 1500);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                userEmailDisplay.textContent = user.email;
                loadingOverlay.style.display = 'flex';
                loadingMessage.textContent = 'Verificando seu acesso...';

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists() && docSnap.data().termsAccepted) {
                        const hasActivePayment = await checkUserPaymentStatus(user);
                        
                        if (hasActivePayment) {
                            showMainApplication();
                        } else {
                            loadingOverlay.style.display = 'none';
                            noAccessScreen.style.display = 'flex';
                        }
                    } else {
                        loadingOverlay.style.display = 'none';
                        termsModal.style.display = 'flex';
                    }
                } catch (error) {
                    console.error("Erro no fluxo de verificação:", error);
                    alert("Ocorreu um erro ao verificar suas permissões. Por favor, tente novamente.");
                    signOut(auth);
                }

            } else {
                loginScreen.style.display = 'flex';
                calculatorContent.style.display = 'none';
                authContainer.style.display = 'none';
                termsModal.style.display = 'none';
                noAccessScreen.style.display = 'none';
                document.body.style.overflow = 'hidden';
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        });

        signInButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            messageElement.style.display = 'none';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    messageElement.textContent = `Erro: E-mail ou senha inválidos.`;
                    messageElement.className = 'message error';
                    messageElement.style.display = 'block';
                });
        });

        signOutButton.addEventListener('click', () => { signOut(auth); });
        logoutFromNoAccessBtn.addEventListener('click', () => { signOut(auth); });

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const email = emailInput.value;
            if (!email) {
                messageElement.textContent = 'Por favor, insira seu e-mail para redefinir a senha.';
                messageElement.className = 'message error';
                messageElement.style.display = 'block';
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    messageElement.textContent = 'E-mail de redefinição enviado!';
                    messageElement.className = 'message success';
                })
                .catch(error => {
                    messageElement.textContent = `Erro ao enviar e-mail.`;
                    messageElement.className = 'message error';
                });
            messageElement.style.display = 'block';
        });

        acceptTermsBtn.addEventListener('click', async () => {
            const currentUser = auth.currentUser;
            if (!currentUser) { return; }

            acceptTermsBtn.disabled = true;
            acceptTermsBtn.textContent = 'Salvando...';

            const userDocRef = doc(db, "users", currentUser.uid);
            try {
                await setDoc(userDocRef, { 
                    email: currentUser.email,
                    termsAccepted: { version: "1.0", timestamp: new Date() } 
                }, { merge: true });

                termsModal.style.display = 'none';
                
                loadingOverlay.style.display = 'flex';
                loadingMessage.textContent = 'Verificando seu acesso...';
                const hasActivePayment = await checkUserPaymentStatus(currentUser);
                if (hasActivePayment) {
                    showMainApplication();
                } else {
                    loadingOverlay.style.display = 'none';
                    noAccessScreen.style.display = 'flex';
                }

            } catch (error) {
                console.error("Erro ao salvar o aceite dos termos: ", error);
                alert("Ocorreu um erro ao salvar sua confirmação. Tente novamente.");
            } finally {
                 acceptTermsBtn.disabled = false;
                 acceptTermsBtn.textContent = 'Li, entendi e aceito os termos';
            }
        });

        declineTermsBtn.addEventListener('click', () => {
            alert('Para usar a plataforma, é necessário aceitar os termos de uso. Você será desconectado.');
            signOut(auth);
        });
        
        // --- LÓGICA DO TOUR E DA CALCULADORA ---
        const tourOverlay = document.getElementById('tour-overlay');
        const tourHighlight = document.querySelector('.tour-highlight');
        const tourTooltip = document.querySelector('.tour-tooltip');
        const tourTitle = document.getElementById('tour-title');
        const tourText = document.getElementById('tour-text');
        const tourStepCounter = document.getElementById('tour-step-counter');
        const tourPrevBtn = document.getElementById('tour-prev-btn');
        const tourNextBtn = document.getElementById('tour-next-btn');
        const tourSkipBtn = document.getElementById('tour-skip-btn');
        const openTutorialButton = document.getElementById('open-tutorial-button');

        const tourSteps = [
            { element: '#tour-step-1', title: 'Navegação Principal', intro: 'Alterne entre os dashboards para suas análises.' },
            { element: '#tour-step-2', title: 'Adicionar Transações', intro: 'Preencha os dados de suas movimentações de capital (envios e retiradas).' },
            { element: '#tour-step-3', title: 'Carregar Cotações', intro: 'Importe o arquivo CSV único com as cotações de compra e venda do dólar.' },
            { element: '#tour-step-4', title: 'Processar Análise', intro: 'Clique aqui para executar os cálculos após preencher os dados acima.' },
            { element: '#main-tab-ir', title: 'Análise de IR', intro: 'Mude para este dashboard para analisar o imposto sobre suas operações de trade.' },
            { element: '#tour-step-5', title: 'Relatório de Operações', intro: 'Importe seu relatório da corretora e a planilha de cotações para o cálculo do IR.' }
        ];

        let currentStep = 0;
        function startTour() { 
            currentStep = 0; 
            tourOverlay.style.display = 'block'; 
            setTimeout(() => showStep(currentStep), 50); 
            localStorage.setItem('xtributationTutorialSeen', 'true'); 
        }
        function endTour() { 
            tourOverlay.classList.remove('active'); 
            setTimeout(() => tourOverlay.style.display = 'none', 300); 
        }
        function showStep(index) {
            const step = tourSteps[index];
            const targetElement = document.querySelector(step.element);
            if (!targetElement) { endTour(); return; }

            const parentContent = targetElement.closest('.main-content');
            if (step.element.includes('ir') || step.element.includes('tour-step-5')) {
                showMainTab('ir');
            } else { 
                showMainTab('cambial');
            }
            
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            
            setTimeout(() => {
                const rect = targetElement.getBoundingClientRect();
                tourHighlight.style.width = `${rect.width + 12}px`;
                tourHighlight.style.height = `${rect.height + 12}px`;
                tourHighlight.style.top = `${rect.top - 6}px`;
                tourHighlight.style.left = `${rect.left - 6}px`;

                tourTitle.textContent = step.title;
                tourText.textContent = step.intro;
                tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
                
                const tooltipHeight = tourTooltip.offsetHeight;
                const tooltipWidth = tourTooltip.offsetWidth;
                if ((rect.bottom + tooltipHeight + 20) > window.innerHeight) {
                    tourTooltip.style.top = `${rect.top - tooltipHeight - 15}px`;
                } else {
                    tourTooltip.style.top = `${rect.bottom + 15}px`;
                }
                
                let tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                if (tooltipLeft < 20) { tooltipLeft = 20; }
                if (tooltipLeft + tooltipWidth > window.innerWidth - 20) {
                    tooltipLeft = window.innerWidth - tooltipWidth - 20;
                }
                tourTooltip.style.left = `${tooltipLeft}px`;
                
                tourPrevBtn.style.display = index === 0 ? 'none' : 'inline-flex';
                tourNextBtn.textContent = index === tourSteps.length - 1 ? 'Finalizar' : 'Próximo';
                tourOverlay.classList.add('active');
            }, 400); 
        }

        tourNextBtn.addEventListener('click', () => { if (currentStep < tourSteps.length - 1) { currentStep++; showStep(currentStep); } else { endTour(); } });
        tourPrevBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; showStep(currentStep); } });
        tourSkipBtn.addEventListener('click', endTour);
        openTutorialButton.addEventListener('click', startTour);
        tourOverlay.addEventListener('click', (e) => { if (e.target === tourOverlay) endTour(); });

        window.showMainTab = function(tabName) {
            document.querySelectorAll('.main-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`main-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`main-tab-${tabName}`).classList.add('active');
        }

        window.addEventListener('mousemove', e => {
            document.documentElement.style.setProperty('--mouse-x', `${e.clientX}px`);
            document.documentElement.style.setProperty('--mouse-y', `${e.clientY}px`);
        });

        let manualTransactions = [];
        let currentlyEditingIndex = null;
        let ratesMapVenda = new Map();
        let ratesMapCompra = new Map();
        let cambialExportData = []; 

        function showLoader(containerId, message = "Processando...") {
             document.getElementById(containerId).innerHTML = `<div class="flex justify-center items-center p-10"><div class="loader !w-8 !h-8"></div><span class="ml-4">${message}</span></div>`;
        }
        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="bg-negative-color bg-opacity-20 border border-negative-color text-text-white p-4 rounded-md" role="alert"><p class="font-bold">ERRO</p><p>${message}</p></div>`;
        }
        function formatCurrency(value, currency = 'BRL', digits = 2) {
            if (typeof value !== 'number' || isNaN(value)) return formatCurrency(0, currency, digits);
            return new Intl.NumberFormat(currency === 'BRL' ? 'pt-BR' : 'en-US', { style: 'currency', currency: currency, minimumFractionDigits: digits }).format(value);
        }

        function formatCurrencyWithColor(value) {
            const formattedValue = formatCurrency(value, 'BRL');
            if (value > 0) return `<span class="text-positive font-semibold">${formattedValue}</span>`;
            if (value < 0) return `<span class="text-negative font-semibold">${formattedValue}</span>`;
            return `<span>${formattedValue}</span>`;
        }
        
        function getRateForDate(date, transType) {
            const ratesMap = (transType === 'Envio') ? ratesMapVenda : ratesMapCompra;
            if (ratesMap.size === 0) return null;
            let currentDate = new Date(date);
            for (let i = 0; i < 7; i++) {
                const lookupDateStr = currentDate.toISOString().split('T')[0];
                if (ratesMap.has(lookupDateStr)) return ratesMap.get(lookupDateStr);
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return null;
        }

        window.toggleNaoRetiradaOption = function() {
            const dateInput = document.getElementById('trans-date');
            const naoRetiradaOption = document.getElementById('nao-retirada-option');
            const typeSelect = document.getElementById('trans-type');
            const dateValue = dateInput.value;
            if (dateValue && dateValue.substring(5) === '12-31') {
                naoRetiradaOption.disabled = false;
            } else {
                naoRetiradaOption.disabled = true;
                if (typeSelect.value === 'Não Retirada') {
                    typeSelect.value = 'Envio';
                }
            }
        }
        document.getElementById('trans-date').addEventListener('change', window.toggleNaoRetiradaOption);
        
        window.handleSaveTransaction = function() {
            const dateInput = document.getElementById('trans-date');
            const typeInput = document.getElementById('trans-type');
            const valueInput = document.getElementById('trans-value');
            const sanitizedValue = valueInput.value.replace(/\./g, '').replace(',', '.');
            const numericValue = parseFloat(sanitizedValue);
            if (!dateInput.value || isNaN(numericValue) || numericValue <= 0) {
                alert('Por favor, preencha a data e um valor positivo válido no formato 1.000,00.');
                return;
            }
            const transactionData = { date: new Date(`${dateInput.value}T00:00:00Z`), type: typeInput.value, value: numericValue };
            if (currentlyEditingIndex !== null) {
                if (currentlyEditingIndex === 0 && (transactionData.type === 'Retirada' || transactionData.type === 'Não Retirada')) {
                    alert('O primeiro lançamento não pode ser editado para "Retirada" ou "Não Retirada".');
                    return;
                }
                manualTransactions[currentlyEditingIndex] = transactionData;
            } else {
                if (manualTransactions.length === 0 && (transactionData.type === 'Retirada' || transactionData.type === 'Não Retirada')) {
                    alert('O primeiro lançamento deve ser obrigatoriamente um ENVIO.');
                    return;
                }
                manualTransactions.push(transactionData);
            }
            manualTransactions.sort((a, b) => a.date - b.date);
            renderTransactionsTable();
            cancelEdit();
        }
        
        window.editTransaction = function(index) {
            currentlyEditingIndex = index;
            const trans = manualTransactions[index];
            document.getElementById('trans-date').value = trans.date.toISOString().split('T')[0];
            document.getElementById('trans-type').value = trans.type;
            document.getElementById('trans-value').value = new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(trans.value);
            document.getElementById('add-trans-button').textContent = 'Salvar Alterações';
            document.getElementById('cancel-edit-button').classList.remove('hidden');
            toggleNaoRetiradaOption();
        }
        
        window.cancelEdit = function() {
            currentlyEditingIndex = null;
            document.getElementById('trans-date').value = '';
            document.getElementById('trans-type').value = 'Envio';
            document.getElementById('trans-value').value = '';
            document.getElementById('add-trans-button').textContent = 'Adicionar +';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            toggleNaoRetiradaOption();
        }

        window.removeTransaction = function(index) {
            if (confirm('Tem certeza que deseja remover este registro?')) {
                manualTransactions.splice(index, 1);
                renderTransactionsTable();
            }
        }
        
        function renderTransactionsTable() {
            const container = document.getElementById('transactions-list');
            if (manualTransactions.length === 0) { container.innerHTML = ''; return; }
            const headers = ['Data', 'Tipo', 'Valor Líquido (USD)', 'Cotação (USD/BRL)', 'Total (R$)', 'Ações'];
            const data = manualTransactions.map((t, index) => {
                const cotacaoDia = getRateForDate(t.date, t.type);
                const cotacaoDisplay = cotacaoDia ? formatCurrency(cotacaoDia, 'BRL') : `<span class="text-xs text-gray-500">Aguardando arquivo</span>`;
                const totalBRL = cotacaoDia ? t.value * cotacaoDia : null;
                const totalBRLDisplay = totalBRL !== null ? formatCurrency(totalBRL, 'BRL') : `<span class="text-xs text-gray-500">---</span>`;
                const actions = `<div class="flex gap-2 justify-center"><button onclick="editTransaction(${index})" class="text-warning-color hover:text-white font-semibold text-xs uppercase">Editar</button><button onclick="removeTransaction(${index})" class="text-negative-color hover:text-white font-semibold text-xs uppercase">Remover</button></div>`;
                return [t.date.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), t.type, formatCurrency(t.value, 'USD'), cotacaoDisplay, totalBRLDisplay, actions];
            });
            let table = `<h4 class="text-md font-semibold mb-2 mt-4 border-t border-border-color pt-4">Registros a Processar:</h4><div class="overflow-x-auto bg-main-bg rounded-md border border-border-color"><table class="min-w-full text-sm"><thead><tr class="bg-card-bg">`;
            headers.forEach(h => table += `<th class="text-center py-2 px-3 font-medium text-gray-400 uppercase tracking-wider">${h}</th>`);
            table += `</tr></thead><tbody class="divide-y divide-border-color">`;
            data.forEach(row => { table += `<tr class="hover:bg-card-bg">`; row.forEach(cell => table += `<td class="py-2 px-3 whitespace-nowrap text-center">${cell}</td>`); table += `</tr>`; });
            table += `</tbody></table></div>`;
            container.innerHTML = table;
        }

        async function handleUnifiedRatesFile(event) {
            const fileInput = event.target;
            const label = document.getElementById('rates-file-unified-label');
            const originalLabelText = "Arquivo de Cotações Unificado (.csv)";
            const file = fileInput.files[0];
            if (!file) return;

            label.textContent = "Carregando...";
            label.style.color = 'var(--warning-color)';
            
            try {
                const results = await new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: false,
                        skipEmptyLines: true,
                        delimitersToGuess: [';', ',', '\t'],
                        complete: resolve,
                        error: reject
                    });
                });

                const allRows = results.data;
                ratesMapCompra.clear();
                ratesMapVenda.clear();
                
                const normalize = (str) => typeof str === 'string' ? str.trim().toLowerCase() : '';
                const headerRowIndex = allRows.findIndex(row => 
                    row.map(normalize).includes('data') &&
                    row.map(normalize).includes('compra') &&
                    row.map(normalize).includes('venda')
                );

                if (headerRowIndex === -1) {
                    throw new Error("Arquivo CSV deve conter uma linha de cabeçalho com as colunas 'Data', 'Compra' e 'Venda'.");
                }
                
                const headerRow = allRows[headerRowIndex].map(normalize);
                const dateIndex = headerRow.indexOf('data');
                const compraIndex = headerRow.indexOf('compra');
                const vendaIndex = headerRow.indexOf('venda');

                const dataRows = allRows.slice(headerRowIndex + 1);

                for (const row of dataRows) {
                    if (row.length <= Math.max(dateIndex, compraIndex, vendaIndex)) continue;
                    const dateStr = row[dateIndex];
                    const compraStr = row[compraIndex];
                    const vendaStr = row[vendaIndex];
                    if (!dateStr || !compraStr || !vendaStr) continue;

                    let date;
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00Z`);
                    } else if (dateStr.includes('-')) {
                        date = new Date(`${dateStr}T00:00:00Z`);
                    } else { continue; }

                    const compraRate = parseFloat(String(compraStr).replace(/[^0-9,]/g, '').replace(',', '.'));
                    const vendaRate = parseFloat(String(vendaStr).replace(/[^0-9,]/g, '').replace(',', '.'));
                    
                    if (date && !isNaN(date.getTime()) && !isNaN(compraRate) && !isNaN(vendaRate)) {
                        const isoDate = date.toISOString().split('T')[0];
                        ratesMapCompra.set(isoDate, compraRate);
                        ratesMapVenda.set(isoDate, vendaRate);
                    }
                }
                
                if (ratesMapCompra.size === 0) {
                    throw new Error("Nenhuma linha de cotação válida foi encontrada no arquivo.");
                }

                renderTransactionsTable();
                label.textContent = `${originalLabelText} (Carregado: ${file.name})`;
                label.style.color = 'var(--positive-color)';

            } catch (error) {
                console.error("Erro ao processar arquivo de cotações unificado:", error);
                showError('results-area-cambial', `Erro ao ler o arquivo ${file.name}: ${error.message}`);
                label.textContent = `${originalLabelText} (Erro!)`;
                label.style.color = 'var(--negative-color)';
            }
        }
        document.getElementById('rates-file-unified').addEventListener('change', handleUnifiedRatesFile);


        window.handleProcessCambial = async function() {
            showLoader('results-area-cambial');
            if (ratesMapVenda.size === 0 || ratesMapCompra.size === 0) {
                showError('results-area-cambial', 'É obrigatório carregar o arquivo de cotações antes de processar.');
                return;
            }
            if (manualTransactions.length === 0) { showError('results-area-cambial', 'Nenhum registro foi adicionado.'); return; }
            try {
                processAndRenderCambial(manualTransactions);
            } catch (error) { showError('results-area-cambial', `Ocorreu um erro: ${error.message}`); }
        }

        function processAndRenderCambial(transactions) {
            try {
                let saldoUSD = 0, custoSaldoBRL = 0, totalEnviosUSD = 0, totalRetiradoUSD = 0, lucroPrejuizoTotal = 0;
                let totalEnviosBRL = 0, totalRetiradoBRL = 0;
                let lucroTributavel = 0;
                let valorNaoRetiradaBRL = null;
                let mostrarAlocarCard = false;
                
                const detailedData = [];
                const detailedDataForExport = [];
                const exportHeaders = ['Data', 'Tipo', 'Valor (USD)', 'Cotação (BRL)', 'Valor (BRL)', 'Lucro/Prejuízo Cambial (BRL)', 'Saldo Final (USD)'];
                
                for (const trans of transactions) {
                    const cotacaoDia = getRateForDate(trans.date, trans.type);
                    if (cotacaoDia === null) throw new Error(`Cotação não encontrada para a data ${trans.date.toLocaleDateString('pt-BR', {timeZone:'UTC'})}. Verifique seus arquivos de cotação.`);
                    
                    const valorDeMercadoBRL = trans.value * cotacaoDia;
                    const precoMedioAnterior = saldoUSD > 1e-6 ? custoSaldoBRL / saldoUSD : 0;
                    let custoOperacaoBRL = 0, lucroPrejuizoRow = 0;
                    
                    if (trans.type === 'Envio') {
                        saldoUSD += trans.value;
                        custoSaldoBRL += valorDeMercadoBRL;
                        totalEnviosUSD += trans.value;
                        totalEnviosBRL += valorDeMercadoBRL;
                        custoOperacaoBRL = valorDeMercadoBRL;
                    } else { 
                        if (trans.value > saldoUSD) throw new Error(`Saque (${formatCurrency(trans.value, 'USD')}) maior que o saldo na data.`);
                        
                        custoOperacaoBRL = trans.value * precoMedioAnterior;
                        lucroPrejuizoRow = valorDeMercadoBRL - custoOperacaoBRL;
                        lucroPrejuizoTotal += lucroPrejuizoRow;

                        if (trans.type === 'Retirada' && lucroPrejuizoRow > 0) {
                            lucroTributavel += lucroPrejuizoRow;
                        }
                        
                        if (trans.type === 'Não Retirada') {
                            custoSaldoBRL += (2 * lucroPrejuizoRow);
                            valorNaoRetiradaBRL = valorDeMercadoBRL;
                            const isLastDayOfYear = trans.date.getUTCMonth() === 11 && trans.date.getUTCDate() === 31;
                            if (isLastDayOfYear) {
                                mostrarAlocarCard = true;
                            }
                        } else { 
                            totalRetiradoUSD += trans.value;
                            totalRetiradoBRL += valorDeMercadoBRL;
                            saldoUSD -= trans.value;
                            custoSaldoBRL -= custoOperacaoBRL;
                        }
                    }
                    
                    const dateLabel = trans.date.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    detailedData.push([dateLabel, trans.type, formatCurrency(trans.value, 'USD'), formatCurrency(cotacaoDia, 'BRL'), formatCurrency(valorDeMercadoBRL, 'BRL'), formatCurrencyWithColor(lucroPrejuizoRow), formatCurrency(saldoUSD, 'USD')]);
                    detailedDataForExport.push({
                        'Data': dateLabel,
                        'Tipo': trans.type,
                        'Valor (USD)': trans.value.toFixed(2),
                        'Cotação (BRL)': cotacaoDia.toFixed(4),
                        'Valor (BRL)': valorDeMercadoBRL.toFixed(2),
                        'Lucro/Prejuízo Cambial (BRL)': lucroPrejuizoRow.toFixed(2),
                        'Saldo Final (USD)': saldoUSD.toFixed(2)
                    });
                }
                
                cambialExportData = { headers: exportHeaders, data: detailedDataForExport };

                const impostoDevido = lucroTributavel * 0.15;
                let cardsImpostoHtml = '';
                if (lucroTributavel > 0) {
                    cardsImpostoHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card p-6 text-center">
                                <p class="text-sm font-medium text-gray-400">VARIAÇÃO CAMBIAL COM RETIRADAS (GANHO / PERDA)</p>
                                <p class="text-3xl font-bold text-white mt-2">${formatCurrency(lucroTributavel)}</p>
                            </div>
                            <div class="card p-6 text-center">
                                <p class="text-sm font-medium text-gray-400">IMPOSTO A PAGAR DA VARIAÇÃO CAMBIAL COM RETIRADAS (15%)</p>
                                <p class="text-3xl font-bold text-accent-color mt-2">${formatCurrency(impostoDevido)}</p>
                            </div>
                        </div>
                    `;
                }

                const saldoBRLCalculado = custoSaldoBRL + lucroPrejuizoTotal;
                let saldoFinalParaExibir;
                
                if (valorNaoRetiradaBRL !== null) {
                    saldoFinalParaExibir = valorNaoRetiradaBRL;
                } else {
                    saldoFinalParaExibir = saldoBRLCalculado; 
                }
                
                if (mostrarAlocarCard) {
                    document.getElementById('alocar-proximo-ano-valor').textContent = formatCurrency(saldoFinalParaExibir);
                    document.getElementById('alocar-proximo-ano-card').classList.remove('hidden');
                } else {
                    document.getElementById('alocar-proximo-ano-card').classList.add('hidden');
                }

                const kpiData = { saldoUSD, custoSaldoBRL: saldoFinalParaExibir, totalEnviosUSD, totalRetiradoUSD, totalEnviosBRL, totalRetiradoBRL };
                const lucroColor = lucroPrejuizoTotal > 0 ? 'text-positive' : lucroPrejuizoTotal < 0 ? 'text-negative' : 'text-white';
                const resultsContainer = document.getElementById('results-area-cambial');
                resultsContainer.innerHTML = `
                    <div id="pdf-export-cambial">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">Resultados dos Envios e Retiradas</h2>
                        </div>
                        <div class="space-y-8">
                             <div class="card p-6 text-center">
                                 <p class="text-sm font-medium text-gray-400">VARIAÇÃO CAMBIAL TOTAL (GANHO / PERDA)</p>
                                 <p class="text-4xl font-bold ${lucroColor} mt-2">${formatCurrency(lucroPrejuizoTotal)}</p>
                             </div>
                            ${cardsImpostoHtml}
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Total Enviado (USD)</p><p class="text-2xl font-bold">${formatCurrency(kpiData.totalEnviosUSD, 'USD')}</p></div>
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Total Retirado (USD)</p><p class="text-2xl font-bold">${formatCurrency(kpiData.totalRetiradoUSD, 'USD')}</p></div>
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Saldo Atual (USD)</p><p class="text-2xl font-bold text-accent-color">${formatCurrency(kpiData.saldoUSD, 'USD')}</p></div>
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Total Enviado (BRL)</p><p class="text-2xl font-bold">${formatCurrency(kpiData.totalEnviosBRL)}</p></div>
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Total Retirado (BRL)</p><p class="text-2xl font-bold">${formatCurrency(kpiData.totalRetiradoBRL)}</p></div>
                                 <div class="card"><p class="text-sm font-medium text-gray-400">Saldo Atual (BRL)</p><p class="text-2xl font-bold">${formatCurrency(kpiData.custoSaldoBRL)}</p></div>
                             </div>
                             <div class="card p-6">
                                 <h3 class="text-xl font-bold mb-4">Extrato Detalhado</h3>
                                 <div class="overflow-x-auto">
                                     <table class="min-w-full">
                                         <thead class="border-b border-border-color">
                                             <tr>
                                                 ${exportHeaders.map(h => `<th class="text-center py-3 px-4 font-semibold text-sm text-text-primary uppercase tracking-wider">${h}</th>`).join('')}
                                             </tr>
                                         </thead>
                                         <tbody class="divide-y divide-border-color">
                                             ${detailedData.map(row => `<tr class="hover:bg-card-bg">${row.map(cell => `<td class="py-4 px-4 whitespace-nowrap text-center">${cell}</td>`).join('')}</tr>`).join('')}
                                         </tbody>
                                     </table>
                                 </div>
                             </div>
                        </div>
                    </div>
                    <div id="cambial-download-buttons-wrapper" class="flex flex-col sm:flex-row gap-4 mt-8">
                        <button id="export-cambial-pdf-button" class="btn btn-secondary w-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>Exportar Relatório (PDF)</span>
                        </button>
                        <button id="export-cambial-xls-button" class="btn btn-secondary w-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Exportar para Excel (.csv)</span>
                        </button>
                    </div>`;

                document.getElementById('export-cambial-pdf-button').addEventListener('click', () => window.print());
                document.getElementById('export-cambial-xls-button').addEventListener('click', exportCambialToXLS);

            } catch (e) { showError('results-area-cambial', `Ocorreu um erro crítico no processamento: ${e.message}`); console.error(e); }
        }

        function exportCambialToXLS() {
            if (!cambialExportData || cambialExportData.data.length === 0) {
                alert('Não há dados para exportar. Processe os dados primeiro.');
                return;
            }
            const csv = Papa.unparse({
                fields: cambialExportData.headers,
                data: cambialExportData.data
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'relatorio_envios_retiradas.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // =======================================================================
        // APURAÇÃO ANUAL DE IR
        // =======================================================================
        let tradesData_IR = null;
        let quotesData_IR = null;
        let finalReportData_IR = null;
        let allProcessedTrades_IR = [];

        const tradesFileInput_IR = document.getElementById('trades-file');
        const quotesFileInput_IR = document.getElementById('quotes-file');
        const processButton_IR = document.getElementById('process-button');
        const resultsSection_IR = document.getElementById('results');
        const alertBox_IR = document.getElementById('alert-box');
        const loader_IR = document.getElementById('loader');
        const buttonText_IR = document.getElementById('button-text');
        const exportPdfButton_IR = document.getElementById('export-pdf-button');
        const exportXlsButton_IR = document.getElementById('export-xls-button');
        const modal_IR = document.getElementById('trades-modal');
        const closeModalButton_IR = document.getElementById('close-modal-button');

        tradesFileInput_IR.addEventListener('change', (event) => handleFileSelect_IR(event, 'trades'));
        quotesFileInput_IR.addEventListener('change', (event) => handleFileSelect_IR(event, 'quotes'));
        processButton_IR.addEventListener('click', processFiles_IR);
        exportPdfButton_IR.addEventListener('click', () => window.print());
        exportXlsButton_IR.addEventListener('click', exportToXLS_IR);
        closeModalButton_IR.addEventListener('click', () => modal_IR.classList.remove('active'));
        modal_IR.addEventListener('click', (e) => { if (e.target === modal_IR) modal_IR.classList.remove('active'); });

        function handleFileSelect_IR(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const nameEl = type === 'trades' ? document.getElementById('trades-file-name') : document.getElementById('quotes-file-name');
            nameEl.textContent = file.name;
            nameEl.classList.add('text-accent-color');
            
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: (results) => {
                    let dataRows = results.data;
                    if (type === 'trades') {
                        if (dataRows.length > 1 && dataRows[0][0] && dataRows[0][0].toLowerCase().includes('posi')) {
                            dataRows.shift();
                        }
                        const headers = dataRows[0].map(h => h.trim());
                        const records = dataRows.slice(1);
                        tradesData_IR = records.map(row => {
                            const obj = {};
                            headers.forEach((header, i) => { if (header) obj[header] = row[i]; });
                            return obj;
                        }).filter(row => Object.values(row).some(val => val !== null && val.toString().trim() !== ''));
                    } else {
                        let headerRowIndex = dataRows.findIndex(row => row.map(cell => cell.toLowerCase()).includes('data'));
                        const headers = dataRows[headerRowIndex];
                        const records = dataRows.slice(headerRowIndex + 1);
                        quotesData_IR = records.map(row => {
                             const obj = {};
                            headers.forEach((header, i) => { if (header) obj[header.trim()] = row[i]; });
                            return obj;
                        }).filter(row => Object.values(row).some(val => val !== null && val.toString().trim() !== ''));
                    }
                },
                error: (error) => showAlert_IR(`Erro ao ler o arquivo ${file.name}: ${error.message}`)
            });
        }

        function showAlert_IR(message) {
            alertBox_IR.textContent = message;
            alertBox_IR.classList.remove('hidden');
        }

        function hideAlert_IR() {
            alertBox_IR.classList.add('hidden');
        }

        function processFiles_IR() {
            hideAlert_IR();
            if (!tradesData_IR || !quotesData_IR) {
                showAlert_IR('Por favor, carregue os dois arquivos para continuar.');
                return;
            }
            loader_IR.classList.remove('hidden');
            buttonText_IR.textContent = 'Processando...';
            processButton_IR.disabled = true;
            setTimeout(() => {
                try {
                    const { apuracaoMensal, plataforma, processedTrades, impostoAnual } = apurarImposto_IR(tradesData_IR, quotesData_IR);
                    finalReportData_IR = apuracaoMensal;
                    allProcessedTrades_IR = processedTrades;
                    displayResults_IR(apuracaoMensal, plataforma, impostoAnual);
                } catch (error) {
                    showAlert_IR(`Ocorreu um erro no cálculo: ${error.message}. Verifique o formato dos seus arquivos.`);
                    console.error(error);
                } finally {
                    loader_IR.classList.add('hidden');
                    buttonText_IR.textContent = 'Apurar Impostos';
                    processButton_IR.disabled = false;
                }
            }, 100);
        }

        function identifyPlatform_IR(data) {
            if (!data || data.length === 0) throw new Error("O arquivo de operações está vazio ou em formato inválido.");
            const columns = new Set(Object.keys(data[0]).map(c => c.toLowerCase().trim().replace(/\s+/g, ' ')));
            if (columns.has('position') && columns.has('ativo') && columns.has('horário') && columns.has('lucro')) {
                return { name: 'Metatrader 5 (Relatório de Posições)', map: { data_fechamento: 'Horário', resultado: 'Lucro', comissao: 'Comissão', swap: 'Swap', ativo: 'Ativo' } };
            }
            if (columns.has('n. do trade') && columns.has('datade fechamento')) {
                return { name: 'Metatrader 5 (Relatório de Negócios)', map: { data_fechamento: 'Datade  Fechamento', resultado: 'Resultado', comissao: 'Comissão', swap: 'Swap', ativo: 'Ativo' } };
            }
            if (columns.has('position') && columns.has('type') && columns.has('deal')) {
                return { name: 'Metatrader 5 (Inglês)', map: { data_fechamento: 'Time', resultado: 'Profit', comissao: 'Commission', swap: 'Swap', ativo: 'Symbol' } };
            }
            if (columns.has('ticket') && columns.has('open time') && columns.has('close time')) {
                return { name: 'Metatrader 4', map: { data_fechamento: 'Close Time', resultado: 'Profit', comissao: 'Commission', swap: 'Swap', ativo: 'Item' } };
            }
            if (columns.has('tradeid') && columns.has('direction') && columns.has('close time')) {
                return { name: 'CTrader', map: { data_fechamento: 'Close Time', resultado: 'Net Profit', comissao: 'Commissions', swap: 'Swap', ativo: 'Symbol' } };
            }
            return null;
        }

        function apurarImposto_IR(trades, quotes) {
            const platformInfo = identifyPlatform_IR(trades);
            if (!platformInfo) throw new Error("Plataforma de trading não identificada. Verifique as colunas do relatório.");
            const normalize = (obj, map) => {
                const newObj = {};
                for (const key in obj) {
                    const normalizedKeyFromFile = key.toLowerCase().trim().replace(/\s+/g, ' ');
                    const standardKey = Object.keys(map).find(k => map[k].toLowerCase().trim().replace(/\s+/g, ' ') === normalizedKeyFromFile);
                    if (standardKey) newObj[standardKey] = obj[key];
                    else newObj[key.toLowerCase().trim().replace(/\s+/g, '_')] = obj[key];
                }
                return newObj;
            };
            let processedTrades = trades.map(t => normalize(t, platformInfo.map));
            if (!quotes || quotes.length === 0) throw new Error("O arquivo de cotações está vazio ou em formato inválido.");
            
            const quotesDateKey = Object.keys(quotes[0]).find(k => k.toLowerCase().trim().includes('data'));
            const quotesCompraKey = Object.keys(quotes[0]).find(k => k.toLowerCase().trim() === 'compra'); 
            
            if (!quotesDateKey || !quotesCompraKey) throw new Error("Não foi possível encontrar as colunas de 'Data' e 'Compra' no arquivo de cotações. Verifique o cabeçalho.");
            
            const quotesMap = quotes.reduce((acc, row) => {
                const dateStr = row[quotesDateKey];
                if (!dateStr) return acc;
                let date;
                if (dateStr.includes('/')) {
                    const parts = dateStr.split(' ')[0].split('/');
                    date = new Date(Date.UTC(parts[2], parts[1] - 1, parts[0]));
                } else {
                    const parts = dateStr.split(' ')[0].split('-');
                    date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }
                if (!isNaN(date.getTime())) acc[date.toISOString().split('T')[0]] = parseFloat(String(row[quotesCompraKey]).replace('R$', '').replace(/\s/g, '').replace(',', '.'));
                return acc;
            }, {});

            processedTrades = processedTrades.map(trade => {
                const parseCurrency = (value) => parseFloat(String(value || '0').replace(/\s/g, '').replace(',', '.')) || 0;
                const profit = parseCurrency(trade.resultado);
                const commission = parseCurrency(trade.comissao);
                const swap = parseCurrency(trade.swap);
                
                const resultado_liquido_usd = profit + commission + swap;
                
                const dateStr = (trade.data_fechamento || '').split(' ')[0];
                let date;
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    date = new Date(Date.UTC(parts[2], parts[1] - 1, parts[0]));
                } else {
                    date = new Date(dateStr.replace(/\./g, '-') + 'T00:00:00Z');
                }
                if (isNaN(date.getTime())) throw new Error(`Valor de data inválido: ${trade.data_fechamento}`);
                const isoDate = date.toISOString().split('T')[0];

                let quote = null;
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date(date);
                    checkDate.setUTCDate(checkDate.getUTCDate() - i);
                    const checkIsoDate = checkDate.toISOString().split('T')[0];
                    if (quotesMap[checkIsoDate]) {
                        quote = quotesMap[checkIsoDate];
                        break;
                    }
                }
                const resultado_liquido_brl = quote ? resultado_liquido_usd * quote : 0;
                
                return { ...trade, data_iso: isoDate, mes_ano: isoDate ? isoDate.substring(0, 7) : null, resultado_liquido_usd, resultado_liquido_brl };
            }).filter(t => t.mes_ano);

            const monthlyGroups = processedTrades.reduce((acc, trade) => {
                const month = trade.mes_ano;
                if (!acc[month]) acc[month] = { resultado_liquido_brl: 0, resultado_liquido_usd: 0 };
                acc[month].resultado_liquido_brl += trade.resultado_liquido_brl;
                acc[month].resultado_liquido_usd += trade.resultado_liquido_usd;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyGroups).sort();
            const apuracaoMensal = sortedMonths.map(month => ({ mes: month, ...monthlyGroups[month] }));

            const lucro_total_anual_brl = processedTrades.reduce((sum, trade) => sum + trade.resultado_liquido_brl, 0);
            const ALIQUOTA_IR = 0.15;
            const impostoAnual = lucro_total_anual_brl > 0 ? lucro_total_anual_brl * ALIQUOTA_IR : 0;

            return { apuracaoMensal, plataforma: platformInfo.name, processedTrades, impostoAnual };
        }

        function displayResults_IR(data, plataforma, impostoAnual) {
            document.getElementById('success-box').innerHTML = `<strong>Plataforma identificada:</strong> ${plataforma}. <strong>Cálculo atualizado conforme Lei 14.754/2023.</strong>`;
            const calendarContainer = document.getElementById('calendar-container');
            calendarContainer.innerHTML = '';
            const formatCurrency = (value, currency = 'BRL') => new Intl.NumberFormat('pt-BR', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            data.forEach(row => {
                const [year, monthNum] = row.mes.split('-');
                const monthName = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                const card = document.createElement('div');
                card.className = `month-card ${row.resultado_liquido_usd >= 0 ? 'profit' : 'loss'} text-center`;
                card.dataset.month = row.mes;
                card.innerHTML = `
                    <div class="month-name">${monthName}</div>
                    <div class="month-result ${row.resultado_liquido_usd >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(row.resultado_liquido_usd, 'USD')}</div>
                    <div class="month-result text-sm ${row.resultado_liquido_brl >= 0 ? 'text-positive' : 'text-negative'} opacity-75">${formatCurrency(row.resultado_liquido_brl, 'BRL')}</div>
                `;
                card.addEventListener('click', () => openTradesModal_IR(row.mes, monthName));
                calendarContainer.appendChild(card);
            });
            let totalUSD = data.reduce((sum, row) => sum + row.resultado_liquido_usd, 0);
            let totalBRL = data.reduce((sum, row) => sum + row.resultado_liquido_brl, 0);
            document.getElementById('total-usd').innerHTML = `<span class="${totalUSD >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(totalUSD, 'USD')}</span>`;
            document.getElementById('total-brl').innerHTML = `<span class="${totalBRL >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(totalBRL)}</span>`;
            document.getElementById('total-tax').textContent = formatCurrency(impostoAnual);
            
            const resultadoAposDarf = totalBRL - impostoAnual;
            const totalAfterTaxEl = document.getElementById('total-after-tax');
            totalAfterTaxEl.innerHTML = `<span class="${resultadoAposDarf >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(resultadoAposDarf)}</span>`;

            // --- INÍCIO: Lógica do Gráfico ---
            const chartCanvas = document.getElementById('monthly-performance-chart');
            if (window.myPerformanceChart instanceof Chart) {
                window.myPerformanceChart.destroy();
            }

            const chartData = {
                labels: data.map(row => {
                    const [year, monthNum] = row.mes.split('-');
                    const monthName = monthNames[parseInt(monthNum) - 1];
                    return `${monthName.substring(0, 3)}/${year.substring(2, 4)}`;
                }),
                datasets: [{
                    label: 'Resultado Líquido (BRL)',
                    data: data.map(row => row.resultado_liquido_brl),
                    backgroundColor: data.map(row => row.resultado_liquido_brl >= 0 ? 'rgba(63, 185, 80, 0.6)' : 'rgba(248, 81, 73, 0.6)'),
                    borderColor: data.map(row => row.resultado_liquido_brl >= 0 ? 'rgba(63, 185, 80, 1)' : 'rgba(248, 81, 73, 1)'),
                    borderWidth: 1
                }]
            };

            const chartOptions = {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#FFFFFF',
                            callback: function(value, index, values) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#FFFFFF' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            };
            window.myPerformanceChart = new Chart(chartCanvas, { type: 'bar', data: chartData, options: chartOptions });
            // --- FIM: Lógica do Gráfico ---

            resultsSection_IR.classList.remove('hidden');
        }

        function openTradesModal_IR(month, monthName) {
            const modalTitle = document.getElementById('modal-title');
            const modalTableBody = document.getElementById('modal-table-body');
            const formatCurrency = (value, currency = 'BRL') => new Intl.NumberFormat('pt-BR', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            modalTitle.textContent = `Operações de ${monthName}`;
            modalTableBody.innerHTML = '';
            const tradesForMonth = allProcessedTrades_IR.filter(trade => trade.mes_ano === month);
            tradesForMonth.forEach(trade => {
                const tr = document.createElement('tr');
                const resultClass = trade.resultado_liquido_usd >= 0 ? 'text-positive' : 'text-negative';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-text-primary">${trade.data_iso}</td>
                    <td class="px-4 py-3 text-sm text-text-headings">${trade.ativo}</td>
                    <td class="px-4 py-3 text-sm text-right font-semibold ${resultClass}">${formatCurrency(trade.resultado_liquido_usd, 'USD')}</td>
                    <td class="px-4 py-3 text-sm text-right font-semibold ${resultClass}">${formatCurrency(trade.resultado_liquido_brl, 'BRL')}</td>
                `;
                modalTableBody.appendChild(tr);
            });
            modal_IR.classList.add('active');
        }

        function exportToXLS_IR() {
            if (!finalReportData_IR || !allProcessedTrades_IR) {
                showAlert_IR('Não há dados para exportar. Apure os impostos primeiro.');
                return;
            }
            const monthlySummary = finalReportData_IR.map(row => ({
                'Mês': row.mes,
                'Resultado Líquido (BRL)': row.resultado_liquido_brl,
                'Resultado Líquido (USD)': row.resultado_liquido_usd
            }));
            const detailedTrades = allProcessedTrades_IR.map(trade => ({
                'Data': trade.data_iso,
                'Ativo': trade.ativo,
                'Resultado (USD)': trade.resultado_liquido_usd,
                'Resultado (BRL)': trade.resultado_liquido_brl
            }));
            const summaryCsv = Papa.unparse(monthlySummary);
            const tradesCsv = Papa.unparse(detailedTrades);
            const fullCsv = "Resumo Mensal\n" + summaryCsv + "\n\nTodas as Operações\n" + tradesCsv;
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'relatorio_apuracao_imposto.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
