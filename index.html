<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTributation - Plataforma Unificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* === SISTEMA DE DESIGN FINAL: TEMA ESCURO PADRONIZADO E CENTRALIZADO === */
        :root {
            /* Paleta de Cores (Dark Mode) */
            --bg-primary: #121217;       /* Fundo principal, cinza muito escuro (quase preto) */
            --surface-card: #1E1E26;    /* Cards e superfícies principais, cinza escuro */
            --border-color: #33333E;     /* Cinza médio para bordas e divisores */
            --text-primary: #E0E0E0;      /* Branco suave para títulos e textos importantes */
            --text-secondary: #A0A0B0;   /* Cinza claro para textos secundários */
            --accent-primary: #FA8231;   /* Laranja principal */
            --accent-hover: #FD9644;     /* Laranja mais claro para hover */
            --positive-color: #20BF6B;   /* Verde para positivo */
            --negative-color: #FC5C65;   /* Vermelho para negativo */
            --warning-color: #F7B731;    /* Amarelo para aviso */

            /* Tipografia */
            --font-family: 'Inter', sans-serif;
            --font-size-base: 16px; /* 1rem */
            --line-height-base: 1.6;

            /* Sistema de Espaçamento (múltiplos de 0.25rem / 4px) */
            --space-xs: 0.5rem;   /* 8px */
            --space-sm: 1rem;     /* 16px */
            --space-md: 1.5rem;   /* 24px */
            --space-lg: 2.5rem;   /* 40px */
            --space-xl: 4rem;     /* 64px */

            /* Bordas e Sombras */
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 10px rgba(0,0,0,0.45);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.6);
            
            /* Transições */
            --transition-fluid: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html { 
            scroll-behavior: smooth; 
            font-size: var(--font-size-base);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            line-height: var(--line-height-base);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .content-wrapper { 
            position: relative; 
            z-index: 1; 
            margin: 0 auto; 
            padding: var(--space-xl) var(--space-md); 
            max-width: 1200px;
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .stagger-in {
            animation: fadeInUp 0.5s var(--transition-fluid) both;
            animation-delay: calc(var(--stagger-index) * 100ms);
        }

        /* === HIERARQUIA TIPOGRÁFICA PADRONIZADA === */
        h1, h2, h3, h4 { 
            color: var(--text-primary); 
            letter-spacing: -0.025em; 
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }
        h1 { font-size: 2.5rem; line-height: 1.2; text-align: center; }
        h2 { font-size: 2rem; line-height: 1.3; text-align: center; }
        h3 { font-size: 1.5rem; line-height: 1.4; }
        h4 { font-size: 1.125rem; font-weight: 600; }

        .text-positive { color: var(--positive-color); }
        .text-negative { color: var(--negative-color); }

        /* === COMPONENTES PADRONIZADOS === */
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: var(--space-xs); 
            padding: 0.75rem var(--space-md); 
            border-radius: var(--border-radius-sm);
            font-weight: 600; 
            font-size: 0.95rem;
            transition: var(--transition-fluid); 
            border: 1px solid transparent; 
            transform: scale(1);
            box-shadow: var(--shadow-sm);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        
        .btn-primary { 
            background: var(--accent-primary);
            color: #FFFFFF; 
            border-color: var(--accent-primary);
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        
        .btn-secondary { 
            background-color: var(--surface-card);
            color: var(--text-primary); 
            border-color: var(--border-color);
        }
        .btn-secondary:hover { color: var(--accent-primary); border-color: var(--accent-primary); background-color: #2A2A35; }
        
        .btn-danger { 
            background-color: transparent; 
            border-color: var(--negative-color); 
            color: var(--negative-color);
        }
        .btn-danger:hover { background-color: var(--negative-color); color: #FFFFFF; }

        .input-field { 
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color); 
            padding: 0.75rem var(--space-sm); 
            width: 100%; 
            transition: var(--transition-fluid); 
            background-color: var(--surface-card); 
            color: var(--text-primary); 
            font-size: 1rem; 
        }
        .input-field:focus { 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 4px rgba(250, 130, 49, 0.2); 
            outline: none; 
        }
        .password-container { position: relative; }
        .password-toggle { position: absolute; top: 50%; right: var(--space-sm); transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; padding: var(--space-xs);}
        .password-toggle:hover { color: var(--text-primary); }
        
        .card {
            background-color: var(--surface-card);
            border-radius: var(--border-radius-lg);
            padding: var(--space-lg);
            position: relative;
            transition: var(--transition-fluid);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .card-border { display: none; }

        .tab-container { 
            display: inline-flex; gap: var(--space-xs); padding: var(--space-xs); 
            background: var(--bg-primary);
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
        }
        .main-tab-button { 
            padding: 0.6rem 1.25rem; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.9rem; 
            transition: var(--transition-fluid); 
            cursor: pointer; 
            border: none; 
        }
        .main-tab-button.active { 
            background-color: var(--accent-primary); 
            color: #FFFFFF; 
            box-shadow: 0 3px 8px -2px rgba(250, 130, 49, 0.4); 
        }
        .main-tab-button:not(.active) { background-color: transparent; color: var(--text-secondary); }
        .main-tab-button:not(.active):hover { color: var(--text-primary); background-color: #2A2A35; }
        
        .hidden { display: none !important; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .month-card { 
            border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: var(--space-md); 
            text-align: center; cursor: pointer; transition: var(--transition-fluid); 
            background-color: var(--surface-card);
            box-shadow: var(--shadow-sm);
        }
        .month-card:hover { transform: translateY(-4px); border-color: var(--accent-primary); box-shadow: var(--shadow-md); }
        .month-card.profit { border-left: 4px solid var(--positive-color); }
        .month-card.loss { border-left: 4px solid var(--negative-color); }
        .month-name { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .month-result { font-size: 1.25rem; font-weight: 700; margin-top: var(--space-xs); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(18, 18, 23, 0.9); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-card); border: 1px solid var(--border-color); padding: var(--space-lg); border-radius: var(--border-radius-lg); max-width: 90%; width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: all 0.3s ease-in-out; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        .important-note { margin-top: var(--space-md); padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-sm); background-color: rgba(247, 183, 49, 0.1); border-left: 4px solid var(--warning-color); }
        .important-note p:first-child { color: var(--warning-color); font-weight: 600;}
        .important-note p:last-child { color: var(--text-primary); opacity: 0.9;}

        #login-screen, #register-screen, #no-access-screen { background-color: var(--bg-primary); display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000; }
        .login-box { text-align: center; width: 100%; max-width: 400px; animation: fadeInUp 0.5s var(--transition-fluid) both; }
        .message { margin-top: var(--space-sm); font-weight: 500; display: none; padding: 0.75rem; border-radius: var(--border-radius-sm); font-size: 0.9rem; }
        .message.error { color: var(--negative-color); background-color: rgba(252, 92, 101, 0.15); border: 1px solid rgba(252, 92, 101, 0.4); }
        .message.success { color: var(--positive-color); background-color: rgba(32, 191, 107, 0.15); border: 1px solid rgba(32, 191, 107, 0.4); }

        #auth-container { position: fixed; top: var(--space-sm); right: var(--space-sm); z-index: 1001; background: var(--surface-card); padding: var(--space-xs) 0.75rem; border-radius: var(--border-radius-sm); display: flex; align-items: center; gap: var(--space-sm); border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: var(--bg-primary); z-index: 1999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; transition: opacity 0.5s ease-out; }
        #animated-logo path { fill: var(--text-primary); opacity: 0; animation: fadeInUp 0.7s ease-out forwards; }
        #animated-logo #logo-part-1 { animation-delay: 0.1s; } #animated-logo #logo-part-2 { animation-delay: 0.2s; } #animated-logo #logo-part-3 { animation-delay: 0.3s; } #animated-logo #logo-part-4 { animation-delay: 0.4s; } #animated-logo #logo-part-5 { animation-delay: 0.5s; } #animated-logo #logo-part-6 { animation-delay: 0.6s; } #animated-logo #logo-part-7 { animation-delay: 0.7s; } #animated-logo #logo-part-8 { animation-delay: 0.8s; }

        #tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9998; opacity: 0; transition: opacity 0.3s ease-out;
            pointer-events: none;
        }
        #tour-overlay.active { opacity: 1; pointer-events: all; }
        .tour-highlight { position: absolute; transition: var(--transition-fluid); border: 2px solid var(--accent-primary); box-shadow: 0 0 25px 5px rgba(250, 130, 49, 0.3); border-radius: var(--border-radius-lg); }
        .tour-tooltip { position: absolute; z-index: 9999; background: var(--surface-card); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); width: 320px; padding: var(--space-md); animation: fadeInUp 0.4s var(--transition-fluid) both; box-shadow: var(--shadow-lg); }
        .tour-nav { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); margin-top: var(--space-md); padding-top: var(--space-sm);}

        #terms-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(18, 18, 23, 0.9); 
            backdrop-filter: blur(8px); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 2500;
            transition: opacity 0.3s ease-in-out;
        }
        .terms-text-container {
            max-height: 55vh;
            overflow-y: auto;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: var(--space-md);
            border-radius: var(--border-radius-sm);
            margin-top: var(--space-sm);
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
            line-height: 1.7;
        }
        .terms-text-container p { margin-bottom: var(--space-sm); }
        .terms-text-container strong { color: var(--text-primary); }
        .terms-text-container h4 { font-weight: 700; color: var(--accent-primary); text-align: center; font-size: 1.25rem; margin-bottom: var(--space-md);}

        .custom-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: var(--space-xs);
            position: relative;
            transition: var(--transition-fluid);
            background-color: var(--surface-card);
        }
        .custom-checkbox:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .custom-checkbox:checked::after {
            content: '✓';
            font-size: 1rem;
            color: #FFFFFF;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        /* === ESTILOS PARA O RESUMO FINANCEIRO PADRONIZADO === */
        .summary-hero-value {
            font-size: 2.75rem;
            font-weight: 800;
            line-height: 1.1;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .summary-item:first-child {
            padding-top: 0;
        }
        .summary-item-label {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .summary-item-label svg {
            width: 1rem;
            height: 1rem;
            stroke-width: 2;
        }
        .summary-item-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .kpi-card {
            background-color: var(--surface-card);
            border-radius: var(--border-radius-sm);
            padding: var(--space-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-fluid);
            text-align: center; /* CENTRALIZA O CONTEÚDO */
        }
        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .kpi-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-xs);
        }
        .kpi-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
    </style>
</head>
<body class="antialiased" style="overflow: hidden;">

    <div id="login-screen" style="display: none;">
        <div class="login-box">
            <h1 class="text-3xl font-semibold mb-3 text-text-primary">Acessar Plataforma</h1>
            <p class="text-base text-text-secondary mb-6">Análise de performance e tributação.</p>
            
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Seu e-mail" class="input-field">
                <div class="password-container">
                    <input type="password" id="password-input" placeholder="Sua senha" class="input-field">
                    <button id="toggle-login-password" class="password-toggle">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                </div>
            </div>

            <button id="sign-in-button" class="mt-6 btn btn-primary w-full text-base py-3">
                <span>Entrar</span>
            </button>
            
            <div class="mt-6 text-sm text-text-secondary">
                É seu primeiro acesso? 
                <a href="#" id="go-to-register-link" class="font-semibold text-accent-primary hover:text-accent-hover transition-colors duration-200">Crie sua conta aqui.</a>
            </div>

             <div class="mt-4 text-sm">
                <a href="#" id="forgot-password-link" class="text-text-secondary hover:text-accent-primary transition-colors duration-200">Esqueceu a senha?</a>
            </div>

            <p id="login-message" class="message"></p>
        </div>
    </div>

    <div id="register-screen" style="display: none;">
        <div class="login-box">
            <h1 class="text-3xl font-semibold mb-3 text-text-primary">Criar Nova Conta</h1>
            <p class="text-base text-text-secondary mb-8">Use o mesmo e-mail que você utilizou na compra.</p>
            <div class="space-y-4">
                <input type="email" id="register-email-input" placeholder="Seu e-mail" class="input-field">
                <div class="password-container">
                    <input type="password" id="register-password-input" placeholder="Crie uma senha (mín. 6 caracteres)" class="input-field">
                    <button id="toggle-register-password" class="password-toggle">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                </div>
                 <div class="password-container">
                    <input type="password" id="register-confirm-password-input" placeholder="Confirme sua senha" class="input-field">
                     <button id="toggle-confirm-password" class="password-toggle">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                </div>
            </div>
            <button id="register-button" class="mt-6 btn btn-primary w-full text-base py-3">
                <span>Cadastrar e Acessar</span>
            </button>
            <div class="mt-6 text-sm">
                 <a href="#" id="go-to-login-link" class="font-semibold text-accent-primary hover:text-accent-hover transition-colors duration-200">Já tem uma conta? Acesse aqui.</a>
            </div>
            <p id="register-message" class="message"></p>
        </div>
    </div>

    <div id="no-access-screen" style="display: none;">
        <div class="login-box">
            <h2 class="text-3xl font-semibold mb-3 text-text-primary">Acesso Negado</h2>
            <p class="text-base text-text-secondary mb-8">
                Não encontramos um pagamento ativo para esta conta. Por favor, verifique o status da sua compra ou entre em contato com o suporte.
            </p>
            <button id="logout-from-no-access" class="mt-6 btn btn-danger w-full text-base py-3">
                <span>Sair</span>
            </button>
        </div>
    </div>
    
    <div id="loading-overlay" style="display: flex; opacity: 1;">
        <div class="text-center">
            <svg id="animated-logo" width="200" height="216" viewBox="0 0 841 1082" version="1.1" xmlns="http://www.w3.org/2000/svg">
              <path id="logo-part-1" d="M 247.5 2 L 258.5 3 L 276.5 7 L 329.5 24 Q 389.9 45.6 446.5 71 L 524.5 110 L 556.5 130 L 581 150.5 L 589 161.5 Q 591.9 166.1 591 174.5 Q 584.3 208.8 560.5 226 Q 553.7 232.2 543.5 235 L 531.5 235 Q 518.7 232.3 512 223.5 Q 493.5 195 470.5 171 L 428.5 183 L 365.5 205 L 329.5 220 L 285.5 243 L 283 243 L 289.5 235 Q 305.3 221.3 324 210.5 Q 279.6 194.9 251 163.5 Q 241.7 152.8 236 138.5 L 232 123.5 L 231 103.5 L 235 82.5 L 238 74.5 L 240.5 72 L 244 74.5 Q 252 101.5 269.5 119 Q 293.7 143.8 328.5 158 L 357.5 168 L 392.5 176 L 404.5 177 L 428.5 170 L 463 163.5 Q 420 121.5 370.5 86 Q 316.4 46.1 254.5 14 L 245 5.5 Q 243.9 2.2 246.5 3 L 247.5 2 Z " />
              <path id="logo-part-2" d="M 236.5 269 L 237 272 Q 193.7 293.9 161 327.5 L 148 345.5 Q 144.2 352.2 144 362.5 Q 145.9 373.6 153.5 379 L 170.5 390 L 200.5 403 L 246.5 416 L 301.5 427 L 309 431.5 L 307.5 434 L 300.5 436 L 299.5 435 L 287.5 435 L 286.5 434 L 276.5 434 L 275.5 433 L 266.5 433 L 265.5 432 L 243.5 430 L 200.5 421 L 154.5 407 Q 143.8 403.2 138 394.5 L 128 374.5 L 126 366.5 L 126 347.5 Q 128.9 333.4 139.5 327 Q 183.4 294.2 236 271 L 236.5 269 Z " />
              <path id="logo-part-3" d="M 531.5 318 Q 572.9 344.6 605 380.5 Q 642.7 421.3 673 469.5 Q 703.5 517.5 728 571.5 Q 754 629 774 692.5 L 799 784.5 L 810 836.5 L 810 842 Q 813.7 840.6 812 846.5 L 819 880.5 L 819 886.5 L 822 899.5 L 822 905.5 L 823 906.5 L 826 933.5 L 828 941.5 L 828 948.5 L 829 949.5 L 829 956.5 L 830 957.5 L 830 965.5 L 831 966.5 L 832 983.5 L 833 984.5 L 833 992.5 L 835 1002.5 L 835 1011.5 L 837 1021.5 L 837 1030.5 L 838 1031.5 L 838 1040.5 L 839 1041.5 L 840 1062.5 L 841 1063.5 L 841 1079.5 L 839 1078.5 L 824 1007.5 L 812 957 Q 808.7 958.3 810 953.5 L 785 858.5 L 748 734.5 L 712 630.5 L 682 556.5 Q 650.8 483.7 611 419.5 L 577 370.5 Q 556.1 342.9 531 319.5 L 531.5 318 Z " />
              <path id="logo-part-4" d="M 369 446 Q 371.7 444.9 371 447.5 L 378 467.5 L 382 488.5 L 383 506.5 L 384 507.5 L 384 550.5 L 383 551.5 L 383 562.5 L 382 563.5 L 381 578.5 L 376 605.5 L 370 629.5 L 361 657.5 L 344 699.5 L 300 786.5 L 297.5 789 L 297 787.5 L 315 742.5 L 337 674.5 L 354 606.5 L 357 586.5 L 359 580.5 L 359 573.5 L 346 520.5 L 326 463.5 L 333 469.5 Q 353.1 494.9 365.5 528 L 367 524.5 L 368 501.5 L 369 500.5 L 370 451.5 L 369 446 Z " />
              <path id="logo-part-5" d="M 179.5 490 L 182 490.5 L 130.5 525 L 96.5 550 Q 64.7 573.7 38 602.5 L 37 621.5 Q 39.4 636.1 46 646.5 Q 56.6 663.4 71.5 676 Q 93.9 695.6 121.5 710 Q 145.4 678.4 174.5 652 Q 210.4 618.9 252.5 592 L 300.5 565 L 321.5 555 L 326.5 554 L 325.5 556 L 309.5 565 L 270.5 594 L 268.5 594 L 219 639.5 Q 149.1 711.1 103 806.5 L 77 883.5 L 58 958.5 L 58 963.5 L 53 987.5 L 53 994.5 L 51 1003.5 L 51 1013.5 L 50 1014.5 L 50 1030.5 L 49 1031.5 L 49 1078.5 L 47.5 1080 L 45 1071.5 L 45 1064.5 L 44 1063.5 L 44 1056.5 L 41 1039.5 L 41 1031.5 L 40 1030.5 L 40 1022.5 L 38 1013.5 L 38 1004.5 L 37 1003.5 L 36 975.5 L 35 974.5 L 35 942.5 L 36 941.5 L 37 914.5 L 38 913.5 L 38 906.5 L 39 905.5 L 42 881.5 L 47 859.5 L 56 829.5 L 71 791.5 Q 84.2 763.4 100 739 L 72.5 734 L 47.5 726 Q 25 717.5 10 701.5 L 1 685.5 L 0 681.5 L 0 662.5 L 9 638.5 Q 21.2 617.2 38 600.5 L 39 594.5 L 46 580.5 Q 57 563.5 72.5 551 Q 91.4 535.4 113.5 523 L 179.5 490 Z " />
              <path id="logo-part-6" d="M 632.5 775 L 640.5 775 L 641 776.5 L 593.5 800 L 577 810 L 575.5 813 Q 540.8 835.3 514 865.5 Q 474 909 448 966.5 L 429 1017.5 L 418.5 1057 L 418 1053.5 L 419 1052.5 L 419 1045.5 L 425 1012.5 L 433 979.5 L 442 949.5 L 458 908.5 Q 471.2 878.7 489 853.5 Q 502 835 518.5 820 L 529 811.5 L 530.5 809 Q 546.3 796.8 566.5 789 L 586.5 783 L 591.5 783 L 632.5 775 Z " />
              <path id="logo-part-7" d="M 338.5 820 Q 341.1 819.2 340 822.5 L 329.5 831 L 259.5 877 Q 231.5 896 209 920.5 Q 173.9 958.9 144 1002.5 Q 127 1026.5 116.5 1057 L 116 1052.5 L 126 1012.5 Q 135.2 986.2 148 963.5 Q 171.4 922.4 205.5 892 Q 232.8 867.8 266.5 850 L 316.5 828 L 338.5 820 Z " />
              <path id="logo-part-8" d="M 361.5 824 L 363 826.5 L 348 902.5 L 347 918.5 L 346 919.5 L 346 948.5 L 347 949.5 L 347 962.5 L 348 963.5 L 349 982.5 L 350 983.5 L 350 990.5 L 351 991.5 L 354 1015.5 L 363 1047.5 L 368 1056.5 L 366 1057 Q 347.3 1031.3 337 996.5 L 333 980.5 L 331 961.5 L 330 960.5 L 330 920.5 L 331 919.5 L 331 912.5 L 334 895.5 L 339 876.5 L 354 837.5 L 359 826.5 L 361.5 824 Z " />
            </svg>
            <p id="loading-message" class="text-text-secondary mt-4">Carregando plataforma...</p>
        </div>
    </div>
    
    <div id="auth-container" style="display: none;" class="no-print">
        <span id="user-email" class="text-text-primary text-sm font-medium"></span>
        <button id="sign-out-button" class="text-xs text-negative-color hover:text-white transition-colors">Sair</button>
    </div>

    <div id="calculator-content" style="display: none;">
        <div class="content-wrapper">
            <header class="mb-12 flex justify-between items-center relative stagger-in no-print" style="--stagger-index: 0;">
                <div class="flex items-center gap-4">
                    <svg width="40" height="40" viewBox="0 0 841 1082" version="1.1" xmlns="http://www.w3.org/2000/svg" class="text-text-primary">
                        <path fill="currentColor" d="M 247.5 2 L 258.5 3 L 276.5 7 L 329.5 24 Q 389.9 45.6 446.5 71 L 524.5 110 L 556.5 130 L 581 150.5 L 589 161.5 Q 591.9 166.1 591 174.5 Q 584.3 208.8 560.5 226 Q 553.7 232.2 543.5 235 L 531.5 235 Q 518.7 232.3 512 223.5 Q 493.5 195 470.5 171 L 428.5 183 L 365.5 205 L 329.5 220 L 285.5 243 L 283 243 L 289.5 235 Q 305.3 221.3 324 210.5 Q 279.6 194.9 251 163.5 Q 241.7 152.8 236 138.5 L 232 123.5 L 231 103.5 L 235 82.5 L 238 74.5 L 240.5 72 L 244 74.5 Q 252 101.5 269.5 119 Q 293.7 143.8 328.5 158 L 357.5 168 L 392.5 176 L 404.5 177 L 428.5 170 L 463 163.5 Q 420 121.5 370.5 86 Q 316.4 46.1 254.5 14 L 245 5.5 Q 243.9 2.2 246.5 3 L 247.5 2 Z M 236.5 269 L 237 272 Q 193.7 293.9 161 327.5 L 148 345.5 Q 144.2 352.2 144 362.5 Q 145.9 373.6 153.5 379 L 170.5 390 L 200.5 403 L 246.5 416 L 301.5 427 L 309 431.5 L 307.5 434 L 300.5 436 L 299.5 435 L 287.5 435 L 286.5 434 L 276.5 434 L 275.5 433 L 266.5 433 L 265.5 432 L 243.5 430 L 200.5 421 L 154.5 407 Q 143.8 403.2 138 394.5 L 128 374.5 L 126 366.5 L 126 347.5 Q 128.9 333.4 139.5 327 Q 183.4 294.2 236 271 L 236.5 269 Z M 531.5 318 Q 572.9 344.6 605 380.5 Q 642.7 421.3 673 469.5 Q 703.5 517.5 728 571.5 Q 754 629 774 692.5 L 799 784.5 L 810 836.5 L 810 842 Q 813.7 840.6 812 846.5 L 819 880.5 L 819 886.5 L 822 899.5 L 822 905.5 L 823 906.5 L 826 933.5 L 828 941.5 L 828 948.5 L 829 949.5 L 829 956.5 L 830 957.5 L 830 965.5 L 831 966.5 L 832 983.5 L 833 984.5 L 833 992.5 L 835 1002.5 L 835 1011.5 L 837 1021.5 L 837 1030.5 L 838 1031.5 L 838 1040.5 L 839 1041.5 L 840 1062.5 L 841 1063.5 L 841 1079.5 L 839 1078.5 L 824 1007.5 L 812 957 Q 808.7 958.3 810 953.5 L 785 858.5 L 748 734.5 L 712 630.5 L 682 556.5 Q 650.8 483.7 611 419.5 L 577 370.5 Q 556.1 342.9 531 319.5 L 531.5 318 Z M 369 446 Q 371.7 444.9 371 447.5 L 378 467.5 L 382 488.5 L 383 506.5 L 384 507.5 L 384 550.5 L 383 551.5 L 383 562.5 L 382 563.5 L 381 578.5 L 376 605.5 L 370 629.5 L 361 657.5 L 344 699.5 L 300 786.5 L 297.5 789 L 297 787.5 L 315 742.5 L 337 674.5 L 354 606.5 L 357 586.5 L 359 580.5 L 359 573.5 L 346 520.5 L 326 463.5 L 333 469.5 Q 353.1 494.9 365.5 528 L 367 524.5 L 368 501.5 L 369 500.5 L 370 451.5 L 369 446 Z M 179.5 490 L 182 490.5 L 130.5 525 L 96.5 550 Q 64.7 573.7 38 602.5 L 37 621.5 Q 39.4 636.1 46 646.5 Q 56.6 663.4 71.5 676 Q 93.9 695.6 121.5 710 Q 145.4 678.4 174.5 652 Q 210.4 618.9 252.5 592 L 300.5 565 L 321.5 555 L 326.5 554 L 325.5 556 L 309.5 565 L 270.5 594 L 268.5 594 L 219 639.5 Q 149.1 711.1 103 806.5 L 77 883.5 L 58 958.5 L 58 963.5 L 53 987.5 L 53 994.5 L 51 1003.5 L 51 1013.5 L 50 1014.5 L 50 1030.5 L 49 1031.5 L 49 1078.5 L 47.5 1080 L 45 1071.5 L 45 1064.5 L 44 1063.5 L 44 1056.5 L 41 1039.5 L 41 1031.5 L 40 1030.5 L 40 1022.5 L 38 1013.5 L 38 1004.5 L 37 1003.5 L 36 975.5 L 35 974.5 L 35 942.5 L 36 941.5 L 37 914.5 L 38 913.5 L 38 906.5 L 39 905.5 L 42 881.5 L 47 859.5 L 56 829.5 L 71 791.5 Q 84.2 763.4 100 739 L 72.5 734 L 47.5 726 Q 25 717.5 10 701.5 L 1 685.5 L 0 681.5 L 0 662.5 L 9 638.5 Q 21.2 617.2 38 600.5 L 39 594.5 L 46 580.5 Q 57 563.5 72.5 551 Q 91.4 535.4 113.5 523 L 179.5 490 Z M 632.5 775 L 640.5 775 L 641 776.5 L 593.5 800 L 577 810 L 575.5 813 Q 540.8 835.3 514 865.5 Q 474 909 448 966.5 L 429 1017.5 L 418.5 1057 L 418 1053.5 L 419 1052.5 L 419 1045.5 L 425 1012.5 L 433 979.5 L 442 949.5 L 458 908.5 Q 471.2 878.7 489 853.5 Q 502 835 518.5 820 L 529 811.5 L 530.5 809 Q 546.3 796.8 566.5 789 L 586.5 783 L 591.5 783 L 632.5 775 Z M 338.5 820 Q 341.1 819.2 340 822.5 L 329.5 831 L 259.5 877 Q 231.5 896 209 920.5 Q 173.9 958.9 144 1002.5 Q 127 1026.5 116.5 1057 L 116 1052.5 L 126 1012.5 Q 135.2 986.2 148 963.5 Q 171.4 922.4 205.5 892 Q 232.8 867.8 266.5 850 L 316.5 828 L 338.5 820 Z M 361.5 824 L 363 826.5 L 348 902.5 L 347 918.5 L 346 919.5 L 346 948.5 L 347 949.5 L 347 962.5 L 348 963.5 L 349 982.5 L 350 983.5 L 350 990.5 L 351 991.5 L 354 1015.5 L 363 1047.5 L 368 1056.5 L 366 1057 Q 347.3 1031.3 337 996.5 L 333 980.5 L 331 961.5 L 330 960.5 L 330 920.5 L 331 919.5 L 331 912.5 L 334 895.5 L 339 876.5 L 354 837.5 L 359 826.5 L 361.5 824 Z " />
                    </svg>
                    <div>
                        <h1 class="text-3xl font-bold text-text-primary tracking-tighter">XTributation</h1>
                        <p class="text-base text-text-secondary">Plataforma de Imposto de Renda XTraders</p>
                    </div>
                </div>
                <button id="open-tutorial-button" class="btn btn-secondary !p-2.5 no-print">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
            </header>
            
            <div class="flex justify-center mb-12 stagger-in no-print" style="--stagger-index: 1;">
                <div id="tour-step-1" class="tab-container">
                    <button id="main-tab-cambial" onclick="showMainTab('cambial')" class="main-tab-button active">Envios e Retiradas</button>
                    <button id="main-tab-ir" onclick="showMainTab('ir')" class="main-tab-button">Apuração Anual de IR</button>
                </div>
            </div>

            <div id="main-content-cambial" class="main-content">
                <div id="cambial-input-area" class="space-y-6 no-print">
                    <div id="tour-step-2" class="card">
                        <h3 class="text-lg font-semibold mb-4 text-text-primary">Adicione um Registro</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label class="block text-xs font-medium mb-1 text-text-secondary">Data</label><input type="date" id="trans-date" class="input-field"></div>
                            <div><label class="block text-xs font-medium mb-1 text-text-secondary">Tipo</label><select id="trans-type" class="input-field"><option value="Envio">Envio</option><option value="Retirada">Retirada</option><option value="Não Retirada" id="nao-retirada-option" disabled>Não Retirada</option></select></div>
                            <div><label class="block text-xs font-medium mb-1 text-text-secondary">Valor Líquido (USD)</label><input type="text" id="trans-value" placeholder="1.000,00" class="input-field"></div>
                            <div class="flex gap-2">
                                <button id="add-trans-button" onclick="handleSaveTransaction()" class="btn btn-secondary w-full">Adicionar +</button>
                                <button id="cancel-edit-button" onclick="cancelEdit()" class="btn btn-secondary w-full hidden" style="border-color: var(--warning-color); color: var(--warning-color);">Cancelar</button>
                            </div>
                        </div>
                        <div class="important-note">
                            <p>MUITO IMPORTANTE:</p>
                            <p class="mt-1 text-sm">NÃO CONSIDERAR OU INFORMAR RETIRADAS DE LUCRO COM OS SEUS TRADES NESTE CAMPO. AQUI DEVE-SE INFORMAR SOMENTE O CAPITAL ORIGINALMENTE ENVIADO OU RETIRADO DO EXTERIOR (MARGEM PARA OPERAR).</p>
                        </div>
                        <div id="transactions-list" class="mt-6"></div>
                    </div>
                    <div id="tour-step-3" class="card">
                        <h3 class="text-lg font-semibold mb-3 text-text-primary">Cotações do Dólar (Obrigatório)</h3>
                        <p class="text-sm mb-4 text-text-secondary">Carregue o arquivo CSV que contém os dados de cotação de compra e venda do dólar, conforme orientado nas aulas.</p>
                        <div>
                             <label class="block text-xs font-medium mb-1 text-text-secondary" for="rates-file-unified" id="rates-file-unified-label">Arquivo de Cotações Unificado (.csv)</label>
                             <input type="file" id="rates-file-unified" accept=".csv" class="input-field">
                        </div>
                    </div>
                    <div id="tour-step-4" class="text-center pt-4">
                        <button onclick="handleProcessCambial()" class="btn btn-primary text-lg px-12 py-3">
                            <span>Processar Dados</span>
                        </button>
                    </div>
                </div>
                <div id="results-area-cambial" class="transition-opacity duration-500 mt-12"></div>
            </div>
            
            <div id="main-content-ir" class="main-content hidden">
                <div id="tour-step-5" class="card stagger-in no-print">
                    <h2 class="text-xl font-semibold mb-6 text-text-primary text-center">Apuração de Imposto de Renda Anual</h2>
                    <p class="text-center text-sm mb-6 -mt-4 text-text-secondary">O cálculo do imposto é consolidado e apurado anualmente.</p>
                    <div id="alert-box" class="hidden p-4 mb-6 text-sm rounded-lg" role="alert"></div>
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <label for="trades-file" class="w-full flex flex-col justify-center items-center p-6 border-2 border-dashed border-border-color rounded-lg cursor-pointer hover:border-accent-primary transition-colors">
                            <svg class="mx-auto h-12 w-12 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <span id="trades-file-name" class="mt-2 text-sm font-semibold text-text-primary">Relatório de Operações (.csv)</span>
                        </label>
                        <input type="file" id="trades-file" accept=".csv" class="hidden"/>
    
                        <label for="quotes-file" class="w-full flex flex-col justify-center items-center p-6 border-2 border-dashed border-border-color rounded-lg cursor-pointer hover:border-accent-primary transition-colors">
                            <svg class="mx-auto h-12 w-12 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <span id="quotes-file-name" class="mt-2 text-sm font-semibold text-text-primary">Planilha de Cotações (.csv)</span>
                        </label>
                        <input type="file" id="quotes-file" accept=".csv" class="hidden"/>
                    </div>
                    <div class="important-note mb-8">
                        <p>MUITO IMPORTANTE:</p>
                        <p class="mt-1 text-sm">Certifique-se de que os relatórios de operações e de cotações correspondem ao mesmo ano-calendário que você deseja apurar. Dados incorretos ou de períodos misturados podem gerar cálculos de imposto inválidos.</p>
                    </div>
                    <button id="process-button" class="btn btn-primary w-full text-base py-3">
                        <span id="button-text">Apurar Impostos</span>
                        <div id="loader" class="loader !w-6 !h-6 hidden ml-3"></div>
                    </button>
                </div>
    
                <div id="results" class="hidden mt-12 stagger-in">
                    <div id="printable-report-area">
                        <div id="success-box" class="p-4 mb-4 text-sm rounded-lg message success" style="display: block;"></div>
                        <h2 class="text-2xl font-bold mb-6 text-text-primary">📊 Resultados da Apuração</h2>
                        
                        <div class="card mb-8">
                            <h3 class="text-xl font-semibold mb-6 text-text-primary border-b border-border-color pb-4">Resumo Financeiro Anual</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                                <div class="md:col-span-1 text-center md:border-r md:border-border-color pr-0 md:pr-8">
                                    <p class="text-base font-medium text-text-secondary uppercase tracking-wider mb-2">Resultado Líquido (BRL)</p>
                                    <p id="total-brl" class="summary-hero-value"></p>
                                </div>
                                <div class="md:col-span-2 space-y-2">
                                    <div class="summary-item">
                                        <span class="summary-item-label">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8v1m0 10v1m0-13a9 9 0 110 18 9 9 0 010-18z" /></svg>
                                            Resultado Líquido (USD)
                                        </span>
                                        <p id="total-usd" class="summary-item-value"></p>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item-label">
                                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                            Imposto Devido (DARF)
                                        </span>
                                        <p id="total-tax" class="summary-item-value"></p>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item-label font-bold text-accent-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                            Resultado Final Pós-DARF
                                        </span>
                                        <p id="total-after-tax" class="summary-item-value font-bold text-accent-primary"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-8 no-print">
                            <h3 class="text-lg font-semibold mb-4 text-text-primary">Desempenho Mensal (BRL)</h3>
                            <div class="h-80">
                                <canvas id="monthly-performance-chart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4 text-text-primary">Calendário Anual de Resultados</h3>
                            <p class="text-sm mb-6 no-print text-text-secondary">Clique em um mês para ver o detalhe das operações.</p>
                            <div id="calendar-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-8 no-print">
                        <button id="open-export-modal-ir-btn" class="btn btn-secondary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Exportar Relatório</span>
                        </button>
                    </div>
                </div>
            </div>
    
        </div>
    </div>

    <div id="trades-modal" class="modal-overlay no-print">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-text-primary"></h2>
                <button id="close-modal-button" class="text-2xl text-text-secondary hover:text-text-primary transition-colors">&times;</button>
            </div>
            <div class="overflow-y-auto max-h-[60vh] rounded-lg border border-border-color">
                <table class="min-w-full divide-y divide-border-color">
                    <thead class="bg-surface-card/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Data</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Ativo</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">Resultado (USD)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">Resultado (BRL)</th>
                        </tr>
                    </thead>
                    <tbody id="modal-table-body" class="divide-y divide-border-color"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="tour-overlay" style="display: none;" class="no-print">
        <div class="tour-highlight"></div>
        <div class="tour-tooltip">
             <h3 id="tour-title" class="text-xl font-bold mb-2 text-text-primary"></h3>
             <p id="tour-text" class="text-base mb-4 text-text-secondary"></p>
             <div class="tour-nav">
                 <button id="tour-skip-btn" class="text-sm text-text-secondary hover:text-text-primary">Pular</button>
                 <div class="flex items-center gap-3">
                     <span id="tour-step-counter" class="text-sm text-text-secondary"></span>
                     <button id="tour-prev-btn" class="btn btn-secondary !py-1.5 !px-3 !text-xs">Anterior</button>
                     <button id="tour-next-btn" class="btn btn-primary !py-1.5 !px-3 !text-xs">Próximo</button>
                 </div>
             </div>
        </div>
    </div>

    <div id="terms-modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="terms-text-container">
                <h4>&gt;&gt; Termos Legais, Condições e Avisos &lt;&lt;</h4>
                <p>Ao utilizar as planilhas, ferramentas, e ao fazer uso das informações contidas no projeto IR, o usuário confirma que leu, entendeu e aceitou os termos, condições e avisos aqui listados.</p>
                <p><strong>17 -</strong> Qualquer cliente que esteja tendo dificuldades com a apuração nas planilhas, ferramentas e informações contidas no Projeto IR poderá solicitar auxílio da equipe responsável, que providenciará a resposta adequada, se possível, com a maior brevidade possível dentro do razoável. Caso o cliente, mesmo após a ajuda, não consiga apurar seu imposto corretamente.</p>
            </div>
            <div class="flex justify-end items-center gap-4 mt-auto pt-6 border-t border-border-color">
                <button id="decline-terms-btn" class="btn btn-danger">Recusar e Sair</button>
                <button id="accept-terms-btn" class="btn btn-primary">Li, entendi e aceito os termos</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay no-print">
        <div class="modal-content !w-[500px]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="export-modal-title" class="text-2xl font-bold text-text-primary">Exportar Relatório</h2>
                <button id="close-export-modal-btn" class="text-2xl text-text-secondary hover:text-text-primary transition-colors">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2 text-text-secondary">Formato do Arquivo</label>
                    <select id="export-format-select" class="input-field">
                        <option value="pdf">PDF (.pdf)</option>
                        <option value="xlsx">Excel (.xlsx)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-3 text-text-secondary">Conteúdo a Incluir</label>
                    <div id="export-options-container" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-border-color flex justify-end">
                <button id="generate-export-btn" class="btn btn-primary">
                    <span id="export-btn-text">Gerar e Baixar</span>
                    <div id="export-loader" class="loader !w-5 !h-5 hidden ml-2"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- INICIALIZAÇÃO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB9yJzA2imAFsUjYGF7S7HzTA3kPNf6P7o",
          authDomain: "calculadora-ir-56a2c.firebaseapp.com",
          projectId: "calculadora-ir-56a2c",
          storageBucket: "calculadora-ir-56a2c.appspot.com",
          messagingSenderId: "613402077853",
          appId: "1:613402077853:web:244d838cc2a99452288274"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const registerScreen = document.getElementById('register-screen');
        const noAccessScreen = document.getElementById('no-access-screen');
        const logoutFromNoAccessBtn = document.getElementById('logout-from-no-access');
        const calculatorContent = document.getElementById('calculator-content');
        const authContainer = document.getElementById('auth-container');
        const userEmailDisplay = document.getElementById('user-email');
        const signOutButton = document.getElementById('sign-out-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const signInButton = document.getElementById('sign-in-button');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const loginMessage = document.getElementById('login-message');
        const registerEmailInput = document.getElementById('register-email-input');
        const registerPasswordInput = document.getElementById('register-password-input');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password-input');
        const registerButton = document.getElementById('register-button');
        const registerMessage = document.getElementById('register-message');
        const goToRegisterLink = document.getElementById('go-to-register-link');
        const goToLoginLink = document.getElementById('go-to-login-link');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const termsModal = document.getElementById('terms-modal-overlay');
        const acceptTermsBtn = document.getElementById('accept-terms-btn');
        const declineTermsBtn = document.getElementById('decline-terms-btn');

        // --- LÓGICA DE VISIBILIDADE DA SENHA ---
        const eyeIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
        const eyeSlashIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18"></path></svg>`;

        function setupPasswordToggle(inputId, toggleId) {
            const passwordField = document.getElementById(inputId);
            const toggleButton = document.getElementById(toggleId);
            if (passwordField && toggleButton) {
                toggleButton.addEventListener('click', () => {
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        toggleButton.innerHTML = eyeSlashIcon;
                    } else {
                        passwordField.type = 'password';
                        toggleButton.innerHTML = eyeIcon;
                    }
                });
            }
        }
        setupPasswordToggle('password-input', 'toggle-login-password');
        setupPasswordToggle('register-password-input', 'toggle-register-password');
        setupPasswordToggle('register-confirm-password-input', 'toggle-confirm-password');

        // --- LÓGICA DE AUTENTICAÇÃO E VERIFICAÇÃO ---
        async function checkUserPaymentStatus(user) {
            if (!user) return false;
            const paymentsRef = collection(db, "payments");
            const q = query(paymentsRef, where("buyerEmail", "==", user.email), where("status", "==", "paid"));
            try {
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error("Erro ao verificar o status do pagamento:", error);
                return false;
            }
        }

        function showMainApplication() {
            loadingMessage.textContent = 'Carregando plataforma...';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                loadingOverlay.addEventListener('transitionend', () => { loadingOverlay.style.display = 'none'; }, { once: true });
                calculatorContent.style.display = 'block';
                authContainer.style.display = 'flex';
                document.body.style.overflow = 'auto';
                if (!localStorage.getItem('xtributationTutorialSeen')) { setTimeout(startTour, 700); }
            }, 1500);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loginScreen.style.display = 'none';
                registerScreen.style.display = 'none';
                userEmailDisplay.textContent = user.email;
                loadingOverlay.style.display = 'flex';
                loadingMessage.textContent = 'Verificando seu acesso...';
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().termsAccepted) {
                        const hasActivePayment = await checkUserPaymentStatus(user);
                        if (hasActivePayment) { showMainApplication(); } 
                        else { loadingOverlay.style.display = 'none'; noAccessScreen.style.display = 'flex'; }
                    } else {
                        loadingOverlay.style.display = 'none';
                        termsModal.style.display = 'flex';
                    }
                } catch (error) {
                    console.error("Erro no fluxo de verificação:", error);
                    alert("Ocorreu um erro ao verificar suas permissões. Tente novamente.");
                    signOut(auth);
                }
            } else {
                loginScreen.style.display = 'flex';
                registerScreen.style.display = 'none';
                calculatorContent.style.display = 'none';
                authContainer.style.display = 'none';
                termsModal.style.display = 'none';
                noAccessScreen.style.display = 'none';
                document.body.style.overflow = 'hidden';
                if (loadingOverlay) { loadingOverlay.style.display = 'none'; }
            }
        });

        // --- EVENT LISTENERS DE NAVEGAÇÃO ---
        goToRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginScreen.style.display = 'none'; registerScreen.style.display = 'flex'; });
        goToLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerScreen.style.display = 'none'; loginScreen.style.display = 'flex'; });
        signInButton.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value).catch(error => {
                loginMessage.textContent = `Erro: E-mail ou senha inválidos.`;
                loginMessage.className = 'message error';
                loginMessage.style.display = 'block';
            });
        });
        registerButton.addEventListener('click', () => {
            if (registerPasswordInput.value !== registerConfirmPasswordInput.value) {
                registerMessage.textContent = 'As senhas não coincidem.';
                registerMessage.className = 'message error';
                registerMessage.style.display = 'block';
                return;
            }
            createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value).catch(error => {
                let msg = 'Ocorreu um erro ao criar a conta.';
                if (error.code === 'auth/email-already-in-use') msg = 'Este e-mail já está cadastrado.';
                else if (error.code === 'auth/weak-password') msg = 'A senha deve ter pelo menos 6 caracteres.';
                else if (error.code === 'auth/invalid-email') msg = 'O formato do e-mail é inválido.';
                registerMessage.textContent = msg;
                registerMessage.className = 'message error';
                registerMessage.style.display = 'block';
            });
        });
        signOutButton.addEventListener('click', () => { signOut(auth); });
        logoutFromNoAccessBtn.addEventListener('click', () => { signOut(auth); });
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (!emailInput.value) {
                loginMessage.textContent = 'Por favor, insira seu e-mail para redefinir a senha.';
                loginMessage.className = 'message error';
                loginMessage.style.display = 'block';
                return;
            }
            sendPasswordResetEmail(auth, emailInput.value)
                .then(() => { loginMessage.textContent = 'E-mail de redefinição enviado!'; loginMessage.className = 'message success'; })
                .catch(error => { loginMessage.textContent = `Erro ao enviar e-mail.`; loginMessage.className = 'message error'; });
            loginMessage.style.display = 'block';
        });
        acceptTermsBtn.addEventListener('click', async () => {
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            acceptTermsBtn.disabled = true;
            acceptTermsBtn.textContent = 'Salvando...';
            const userDocRef = doc(db, "users", currentUser.uid);
            try {
                await setDoc(userDocRef, { email: currentUser.email, termsAccepted: { version: "1.0", timestamp: new Date() } }, { merge: true });
                termsModal.style.display = 'none';
                loadingOverlay.style.display = 'flex';
                loadingMessage.textContent = 'Verificando seu acesso...';
                const hasActivePayment = await checkUserPaymentStatus(currentUser);
                if (hasActivePayment) { showMainApplication(); } 
                else { loadingOverlay.style.display = 'none'; noAccessScreen.style.display = 'flex'; }
            } catch (error) {
                alert("Ocorreu um erro ao salvar sua confirmação. Tente novamente.");
            } finally {
                acceptTermsBtn.disabled = false;
                acceptTermsBtn.textContent = 'Li, entendi e aceito os termos';
            }
        });
        declineTermsBtn.addEventListener('click', () => { signOut(auth); });

        // --- LÓGICA DO TOUR E GERAL ---
        const tourOverlay = document.getElementById('tour-overlay');
        const tourHighlight = document.querySelector('.tour-highlight');
        const tourTooltip = document.querySelector('.tour-tooltip');
        const tourTitle = document.getElementById('tour-title');
        const tourText = document.getElementById('tour-text');
        const tourStepCounter = document.getElementById('tour-step-counter');
        const tourPrevBtn = document.getElementById('tour-prev-btn');
        const tourNextBtn = document.getElementById('tour-next-btn');
        const tourSkipBtn = document.getElementById('tour-skip-btn');
        const openTutorialButton = document.getElementById('open-tutorial-button');
        const tourSteps = [
            { element: '#tour-step-1', title: 'Navegação Principal', intro: 'Alterne entre os dashboards para suas análises.' },
            { element: '#tour-step-2', title: 'Adicionar Transações', intro: 'Preencha os dados de suas movimentações de capital (envios e retiradas).' },
            { element: '#tour-step-3', title: 'Carregar Cotações', intro: 'Importe o arquivo CSV único com as cotações de compra e venda do dólar.' },
            { element: '#tour-step-4', title: 'Processar Análise', intro: 'Clique aqui para executar os cálculos após preencher os dados acima.' },
            { element: '#main-tab-ir', title: 'Análise de IR', intro: 'Mude para este dashboard para analisar o imposto sobre suas operações de trade.' },
            { element: '#tour-step-5', title: 'Relatório de Operações', intro: 'Importe seu relatório da corretora e a planilha de cotações para o cálculo do IR.' }
        ];
        let currentStep = 0;
        function startTour() { currentStep = 0; tourOverlay.style.display = 'block'; setTimeout(() => showStep(currentStep), 50); localStorage.setItem('xtributationTutorialSeen', 'true'); }
        function endTour() { tourOverlay.classList.remove('active'); setTimeout(() => tourOverlay.style.display = 'none', 300); }
        function showStep(index) {
            const step = tourSteps[index];
            const targetElement = document.querySelector(step.element);
            if (!targetElement) { endTour(); return; }
            if (step.element.includes('ir') || step.element.includes('tour-step-5')) { showMainTab('ir'); } else { showMainTab('cambial'); }
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            setTimeout(() => {
                const rect = targetElement.getBoundingClientRect();
                tourHighlight.style.width = `${rect.width + 12}px`;
                tourHighlight.style.height = `${rect.height + 12}px`;
                tourHighlight.style.top = `${rect.top - 6}px`;
                tourHighlight.style.left = `${rect.left - 6}px`;
                tourTitle.textContent = step.title;
                tourText.textContent = step.intro;
                tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
                const tooltipHeight = tourTooltip.offsetHeight;
                const tooltipWidth = tourTooltip.offsetWidth;
                if ((rect.bottom + tooltipHeight + 20) > window.innerHeight) { tourTooltip.style.top = `${rect.top - tooltipHeight - 15}px`; } 
                else { tourTooltip.style.top = `${rect.bottom + 15}px`; }
                let tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                if (tooltipLeft < 20) tooltipLeft = 20;
                if (tooltipLeft + tooltipWidth > window.innerWidth - 20) tooltipLeft = window.innerWidth - tooltipWidth - 20;
                tourTooltip.style.left = `${tooltipLeft}px`;
                tourPrevBtn.style.display = index === 0 ? 'none' : 'inline-flex';
                tourNextBtn.textContent = index === tourSteps.length - 1 ? 'Finalizar' : 'Próximo';
                tourOverlay.classList.add('active');
            }, 400); 
        }
        tourNextBtn.addEventListener('click', () => { if (currentStep < tourSteps.length - 1) { currentStep++; showStep(currentStep); } else { endTour(); } });
        tourPrevBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; showStep(currentStep); } });
        tourSkipBtn.addEventListener('click', endTour);
        openTutorialButton.addEventListener('click', startTour);
        tourOverlay.addEventListener('click', (e) => { if (e.target === tourOverlay) endTour(); });
        window.showMainTab = function(tabName) {
            document.querySelectorAll('.main-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`main-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`main-tab-${tabName}`).classList.add('active');
        }
        
        // --- FUNÇÕES AUXILIARES GLOBAIS ---
        function showLoader(containerId, message = "Processando...") {
             document.getElementById(containerId).innerHTML = `<div class="flex justify-center items-center p-10"><div class="loader"></div><span class="ml-4 text-text-secondary">${message}</span></div>`;
        }
        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="message error" style="display:block;"><p class="font-bold">ERRO</p><p>${message}</p></div>`;
        }
        function formatCurrency(value, currency = 'BRL', digits = 2) {
            if (typeof value !== 'number' || isNaN(value)) return formatCurrency(0, currency, digits);
            return new Intl.NumberFormat(currency === 'BRL' ? 'pt-BR' : 'en-US', { style: 'currency', currency: currency, minimumFractionDigits: digits }).format(value);
        }
        function formatCurrencyWithColor(value) {
            const formattedValue = formatCurrency(value, 'BRL');
            if (value > 0) return `<span class="text-positive font-semibold">${formattedValue}</span>`;
            if (value < 0) return `<span class="text-negative font-semibold">${formattedValue}</span>`;
            return `<span>${formattedValue}</span>`;
        }

        // =======================================================================
        // DASHBOARD CAMBIAL (ABA 1) - LÓGICA
        // =======================================================================
        let manualTransactions = [];
        let currentlyEditingIndex = null;
        let ratesMapVenda = new Map();
        let ratesMapCompra = new Map();
        let cambialExportData = [];
        let cambialKpiData = {};

        function getRateForDate(date, transType) {
            const ratesMap = (transType === 'Envio') ? ratesMapVenda : ratesMapCompra;
            if (ratesMap.size === 0) return null;
            let currentDate = new Date(date);
            for (let i = 0; i < 7; i++) {
                const lookupDateStr = currentDate.toISOString().split('T')[0];
                if (ratesMap.has(lookupDateStr)) return ratesMap.get(lookupDateStr);
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return null;
        }

        window.toggleNaoRetiradaOption = function() {
            const dateInput = document.getElementById('trans-date');
            const naoRetiradaOption = document.getElementById('nao-retirada-option');
            const typeSelect = document.getElementById('trans-type');
            const dateValue = dateInput.value;
            if (dateValue && dateValue.substring(5) === '12-31') {
                naoRetiradaOption.disabled = false;
            } else {
                naoRetiradaOption.disabled = true;
                if (typeSelect.value === 'Não Retirada') typeSelect.value = 'Envio';
            }
        }
        document.getElementById('trans-date').addEventListener('change', window.toggleNaoRetiradaOption);
        
        window.handleSaveTransaction = function() {
            const dateInput = document.getElementById('trans-date');
            const typeInput = document.getElementById('trans-type');
            const valueInput = document.getElementById('trans-value');
            const sanitizedValue = valueInput.value.replace(/\./g, '').replace(',', '.');
            const numericValue = parseFloat(sanitizedValue);
            if (!dateInput.value || isNaN(numericValue) || numericValue <= 0) {
                alert('Por favor, preencha a data e um valor positivo válido no formato 1.000,00.');
                return;
            }
            const transactionData = { date: new Date(`${dateInput.value}T00:00:00Z`), type: typeInput.value, value: numericValue };
            if (currentlyEditingIndex !== null) {
                if (currentlyEditingIndex === 0 && (transactionData.type === 'Retirada' || transactionData.type === 'Não Retirada')) {
                    alert('O primeiro lançamento não pode ser editado para "Retirada" ou "Não Retirada".'); return;
                }
                manualTransactions[currentlyEditingIndex] = transactionData;
            } else {
                if (manualTransactions.length === 0 && (transactionData.type === 'Retirada' || transactionData.type === 'Não Retirada')) {
                    alert('O primeiro lançamento deve ser obrigatoriamente um ENVIO.'); return;
                }
                manualTransactions.push(transactionData);
            }
            manualTransactions.sort((a, b) => a.date - b.date);
            renderTransactionsTable();
            cancelEdit();
        }
        
        window.editTransaction = function(index) {
            currentlyEditingIndex = index;
            const trans = manualTransactions[index];
            document.getElementById('trans-date').value = trans.date.toISOString().split('T')[0];
            document.getElementById('trans-type').value = trans.type;
            document.getElementById('trans-value').value = new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(trans.value);
            document.getElementById('add-trans-button').textContent = 'Salvar Alterações';
            document.getElementById('cancel-edit-button').classList.remove('hidden');
            toggleNaoRetiradaOption();
        }
        
        window.cancelEdit = function() {
            currentlyEditingIndex = null;
            document.getElementById('trans-date').value = '';
            document.getElementById('trans-type').value = 'Envio';
            document.getElementById('trans-value').value = '';
            document.getElementById('add-trans-button').textContent = 'Adicionar +';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            toggleNaoRetiradaOption();
        }

        window.removeTransaction = function(index) {
            if (confirm('Tem certeza que deseja remover este registro?')) {
                manualTransactions.splice(index, 1);
                renderTransactionsTable();
            }
        }
        
        function renderTransactionsTable() {
            const container = document.getElementById('transactions-list');
            if (manualTransactions.length === 0) { container.innerHTML = ''; return; }
            const headers = ['Data', 'Tipo', 'Valor (USD)', 'Cotação (BRL)', 'Total (R$)', 'Ações'];
            const data = manualTransactions.map((t, index) => {
                const cotacaoDia = getRateForDate(t.date, t.type);
                const cotacaoDisplay = cotacaoDia ? formatCurrency(cotacaoDia, 'BRL') : `<span class="text-xs text-text-secondary">Aguardando arquivo</span>`;
                const totalBRL = cotacaoDia ? t.value * cotacaoDia : null;
                const totalBRLDisplay = totalBRL !== null ? formatCurrency(totalBRL, 'BRL') : `<span class="text-xs text-text-secondary">---</span>`;
                const actions = `<div class="flex gap-2 justify-center"><button onclick="editTransaction(${index})" class="text-warning-color hover:text-text-primary font-semibold text-xs uppercase">Editar</button><button onclick="removeTransaction(${index})" class="text-negative-color hover:text-white font-semibold text-xs uppercase">Remover</button></div>`;
                return [t.date.toLocaleDateString('pt-BR', {timeZone: 'UTC'}), t.type, formatCurrency(t.value, 'USD'), cotacaoDisplay, totalBRLDisplay, actions];
            });
            let table = `<h4 class="text-md font-semibold mb-2 mt-4 border-t border-border-color pt-4">Registros a Processar:</h4><div class="overflow-x-auto bg-bg-primary rounded-md border border-border-color"><table class="min-w-full text-sm"><thead><tr class="bg-surface-card/50">`;
            headers.forEach(h => table += `<th class="text-center py-2 px-3 font-medium text-text-secondary uppercase tracking-wider">${h}</th>`);
            table += `</tr></thead><tbody class="divide-y divide-border-color">`;
            data.forEach(row => { table += `<tr class="hover:bg-surface-card/50">`; row.forEach(cell => table += `<td class="py-2 px-3 whitespace-nowrap text-center">${cell}</td>`); table += `</tr>`; });
            table += `</tbody></table></div>`;
            container.innerHTML = table;
        }

        async function handleUnifiedRatesFile(event) {
            const fileInput = event.target;
            const label = document.getElementById('rates-file-unified-label');
            const originalLabelText = "Arquivo de Cotações Unificado (.csv)";
            const file = fileInput.files[0];
            if (!file) return;

            label.textContent = "Carregando...";
            label.style.color = 'var(--warning-color)';
            
            try {
                const results = await new Promise((resolve, reject) => {
                    Papa.parse(file, { header: false, skipEmptyLines: true, delimitersToGuess: [';', ',', '\t'], complete: resolve, error: reject });
                });
                const allRows = results.data;
                ratesMapCompra.clear(); ratesMapVenda.clear();
                const normalize = (str) => typeof str === 'string' ? str.trim().toLowerCase() : '';
                const headerRowIndex = allRows.findIndex(row => row.map(normalize).includes('data') && row.map(normalize).includes('compra') && row.map(normalize).includes('venda'));
                if (headerRowIndex === -1) throw new Error("Arquivo CSV deve conter 'Data', 'Compra' e 'Venda'.");
                const headerRow = allRows[headerRowIndex].map(normalize);
                const dateIndex = headerRow.indexOf('data');
                const compraIndex = headerRow.indexOf('compra');
                const vendaIndex = headerRow.indexOf('venda');
                const dataRows = allRows.slice(headerRowIndex + 1);
                for (const row of dataRows) {
                    if (row.length <= Math.max(dateIndex, compraIndex, vendaIndex)) continue;
                    const [dateStr, compraStr, vendaStr] = [row[dateIndex], row[compraIndex], row[vendaIndex]];
                    if (!dateStr || !compraStr || !vendaStr) continue;
                    let date;
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00Z`);
                    } else if (dateStr.includes('-')) {
                        date = new Date(`${dateStr}T00:00:00Z`);
                    } else { continue; }
                    const compraRate = parseFloat(String(compraStr).replace(/[^0-9,]/g, '').replace(',', '.'));
                    const vendaRate = parseFloat(String(vendaStr).replace(/[^0-9,]/g, '').replace(',', '.'));
                    if (date && !isNaN(date.getTime()) && !isNaN(compraRate) && !isNaN(vendaRate)) {
                        const isoDate = date.toISOString().split('T')[0];
                        ratesMapCompra.set(isoDate, compraRate);
                        ratesMapVenda.set(isoDate, vendaRate);
                    }
                }
                if (ratesMapCompra.size === 0) throw new Error("Nenhuma cotação válida foi encontrada.");
                renderTransactionsTable();
                label.textContent = `${originalLabelText} (Carregado: ${file.name})`;
                label.style.color = 'var(--positive-color)';
            } catch (error) {
                showError('results-area-cambial', `Erro ao ler o arquivo: ${error.message}`);
                label.textContent = `${originalLabelText} (Erro!)`;
                label.style.color = 'var(--negative-color)';
            }
        }
        document.getElementById('rates-file-unified').addEventListener('change', handleUnifiedRatesFile);

        window.handleProcessCambial = async function() {
            showLoader('results-area-cambial');
            if (ratesMapVenda.size === 0 || ratesMapCompra.size === 0) {
                showError('results-area-cambial', 'É obrigatório carregar o arquivo de cotações antes de processar.'); return;
            }
            if (manualTransactions.length === 0) { showError('results-area-cambial', 'Nenhum registro foi adicionado.'); return; }
            try { processAndRenderCambial(manualTransactions); } catch (error) { showError('results-area-cambial', `Ocorreu um erro: ${error.message}`); }
        }

        function processAndRenderCambial(transactions) {
            try {
                let saldoUSD = 0, custoSaldoBRL = 0, totalEnviosUSD = 0, totalRetiradoUSD = 0, lucroPrejuizoTotal = 0;
                let totalEnviosBRL = 0, totalRetiradoBRL = 0;
                let lucroTributavel = 0;
                let valorNaoRetiradaBRL = null;
                let mostrarAlocarCard = false;
                
                const detailedData = [];
                const detailedDataForExport = [];
                const exportHeaders = ['Data', 'Tipo', 'Valor (USD)', 'Cotação (BRL)', 'Valor (BRL)', 'Lucro/Prejuízo Cambial (BRL)', 'Saldo Final (USD)'];
                
                for (const trans of transactions) {
                    const cotacaoDia = getRateForDate(trans.date, trans.type);
                    if (cotacaoDia === null) throw new Error(`Cotação não encontrada para a data ${trans.date.toLocaleDateString('pt-BR', {timeZone:'UTC'})}.`);
                    
                    const valorDeMercadoBRL = trans.value * cotacaoDia;
                    const precoMedioAnterior = saldoUSD > 1e-6 ? custoSaldoBRL / saldoUSD : 0;
                    let custoOperacaoBRL = 0, lucroPrejuizoRow = 0;
                    
                    if (trans.type === 'Envio') {
                        saldoUSD += trans.value;
                        custoSaldoBRL += valorDeMercadoBRL;
                        totalEnviosUSD += trans.value;
                        totalEnviosBRL += valorDeMercadoBRL;
                    } else { 
                        if (trans.value > saldoUSD) throw new Error(`Saque (${formatCurrency(trans.value, 'USD')}) maior que o saldo na data.`);
                        custoOperacaoBRL = trans.value * precoMedioAnterior;
                        lucroPrejuizoRow = valorDeMercadoBRL - custoOperacaoBRL;
                        lucroPrejuizoTotal += lucroPrejuizoRow;
                        if (trans.type === 'Retirada' && lucroPrejuizoRow > 0) {
                            lucroTributavel += lucroPrejuizoRow;
                        }
                        if (trans.type === 'Não Retirada') {
                            custoSaldoBRL += (2 * lucroPrejuizoRow);
                            valorNaoRetiradaBRL = valorDeMercadoBRL;
                            if (trans.date.getUTCMonth() === 11 && trans.date.getUTCDate() === 31) {
                                mostrarAlocarCard = true;
                            }
                        } else { 
                            totalRetiradoUSD += trans.value;
                            totalRetiradoBRL += valorDeMercadoBRL;
                            saldoUSD -= trans.value;
                            custoSaldoBRL -= custoOperacaoBRL;
                        }
                    }
                    const dateLabel = trans.date.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    detailedData.push([dateLabel, trans.type, formatCurrency(trans.value, 'USD'), formatCurrency(cotacaoDia, 'BRL'), formatCurrency(valorDeMercadoBRL, 'BRL'), formatCurrencyWithColor(lucroPrejuizoRow), formatCurrency(saldoUSD, 'USD')]);
                    detailedDataForExport.push({ 'Data': dateLabel, 'Tipo': trans.type, 'Valor (USD)': trans.value, 'Cotação (BRL)': cotacaoDia, 'Valor (BRL)': valorDeMercadoBRL, 'Lucro/Prejuízo Cambial (BRL)': lucroPrejuizoRow, 'Saldo Final (USD)': saldoUSD });
                }
                cambialExportData = { headers: exportHeaders, data: detailedDataForExport };
                const impostoDevido = lucroTributavel * 0.15;
                const saldoBRLCalculado = custoSaldoBRL + lucroPrejuizoTotal;
                let saldoFinalParaExibir = (valorNaoRetiradaBRL !== null) ? valorNaoRetiradaBRL : saldoBRLCalculado; 
                
                cambialKpiData = { saldoUSD, custoSaldoBRL: saldoFinalParaExibir, totalEnviosUSD, totalRetiradoUSD, totalEnviosBRL, totalRetiradoBRL, lucroPrejuizoTotal, lucroTributavel, impostoDevido };
                const lucroColor = lucroPrejuizoTotal >= 0 ? 'text-positive' : 'text-negative';
                const resultsContainer = document.getElementById('results-area-cambial');
                
                const kpiCards = [];
                if (mostrarAlocarCard) {
                    kpiCards.push({ title: 'Alocar para Próximo Ano', value: formatCurrency(saldoFinalParaExibir), color: 'text-accent-primary'});
                }
                kpiCards.push({ title: 'Variação Cambial Total', value: formatCurrency(lucroPrejuizoTotal), color: lucroColor });
                kpiCards.push({ title: 'Saldo Atual (BRL)', value: formatCurrency(saldoFinalParaExibir), color: 'text-accent-primary' });
                kpiCards.push({ title: 'Imposto a Pagar (15%)', value: formatCurrency(impostoDevido), color: 'text-negative'});
                kpiCards.push({ title: 'Saldo Atual (USD)', value: formatCurrency(saldoUSD, 'USD'), color: 'text-text-primary'});
                kpiCards.push({ title: 'Total Enviado (USD)', value: formatCurrency(totalEnviosUSD, 'USD'), color: 'text-text-primary'});
                kpiCards.push({ title: 'Total Retirado (USD)', value: formatCurrency(totalRetiradoUSD, 'USD'), color: 'text-text-primary'});
                kpiCards.push({ title: 'Total Enviado (BRL)', value: formatCurrency(totalEnviosBRL), color: 'text-text-primary'});
                kpiCards.push({ title: 'Total Retirado (BRL)', value: formatCurrency(totalRetiradoBRL), color: 'text-text-primary'});

                const kpiGridClass = mostrarAlocarCard 
                    ? 'grid grid-cols-1 md:grid-cols-3 gap-4'
                    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4';
                
                const kpiCardsHtml = kpiCards.map(kpi => `
                    <div class="kpi-card">
                        <p class="kpi-card-title">${kpi.title}</p>
                        <p class="kpi-card-value ${kpi.color}">${kpi.value}</p>
                    </div>
                `).join('');

                resultsContainer.innerHTML = `
                    <div id="pdf-export-cambial" class="space-y-6">
                        <h3 class="text-xl font-bold text-text-primary text-left">Resumo da Movimentação Cambial</h3>
                        <div class="${kpiGridClass}">
                            ${kpiCardsHtml}
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-bold mb-4 text-left">Extrato Detalhado</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="border-b border-border-color">
                                        <tr>${exportHeaders.map(h => `<th class="text-left py-3 px-4 font-semibold text-sm text-text-secondary uppercase tracking-wider">${h}</th>`).join('')}</tr>
                                    </thead>
                                    <tbody class="divide-y divide-border-color">
                                        ${detailedData.map(row => `<tr>${row.map(cell => `<td class="py-4 px-4 whitespace-nowrap">${cell}</td>`).join('')}</tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-8 no-print">
                        <button id="open-export-modal-cambial-btn" class="btn btn-secondary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Exportar Relatório</span>
                        </button>
                    </div>`;
                document.getElementById('open-export-modal-cambial-btn').addEventListener('click', () => openExportModal('cambial'));

            } catch (e) { 
                showError('results-area-cambial', `Ocorreu um erro crítico no processamento: ${e.message}`); 
                console.error(e); 
            }
        }
        
        // =======================================================================
        // APURAÇÃO ANUAL DE IR (ABA 2) - LÓGICA
        // =======================================================================
        let tradesData_IR = null; let quotesData_IR = null; let finalReportData_IR = null; let allProcessedTrades_IR = []; let irKpiData = {};
        const tradesFileInput_IR = document.getElementById('trades-file'); const quotesFileInput_IR = document.getElementById('quotes-file'); const processButton_IR = document.getElementById('process-button'); const resultsSection_IR = document.getElementById('results'); const alertBox_IR = document.getElementById('alert-box'); const loader_IR = document.getElementById('loader'); const buttonText_IR = document.getElementById('button-text'); const modal_IR = document.getElementById('trades-modal'); const closeModalButton_IR = document.getElementById('close-modal-button'); const openExportModalIrBtn = document.getElementById('open-export-modal-ir-btn');
        tradesFileInput_IR.addEventListener('change', (event) => handleFileSelect_IR(event, 'trades'));
        quotesFileInput_IR.addEventListener('change', (event) => handleFileSelect_IR(event, 'quotes'));
        processButton_IR.addEventListener('click', processFiles_IR);
        openExportModalIrBtn.addEventListener('click', () => openExportModal('ir'));
        closeModalButton_IR.addEventListener('click', () => modal_IR.classList.remove('active'));
        modal_IR.addEventListener('click', (e) => { if (e.target === modal_IR) modal_IR.classList.remove('active'); });
        function handleFileSelect_IR(event, type) {
            const file = event.target.files[0]; if (!file) return;
            const nameEl = type === 'trades' ? document.getElementById('trades-file-name') : document.getElementById('quotes-file-name');
            nameEl.textContent = file.name; nameEl.classList.add('text-accent-primary');
            Papa.parse(file, { header: false, skipEmptyLines: true, complete: (results) => { let dataRows = results.data; if (type === 'trades') { if (dataRows.length > 1 && dataRows[0][0] && dataRows[0][0].toLowerCase().includes('posi')) dataRows.shift(); const headers = dataRows[0].map(h => h.trim()); const records = dataRows.slice(1); tradesData_IR = records.map(row => { const obj = {}; headers.forEach((header, i) => { if (header) obj[header] = row[i]; }); return obj; }).filter(row => Object.values(row).some(val => val !== null && val.toString().trim() !== '')); } else { let headerRowIndex = dataRows.findIndex(row => row.map(cell => cell.toLowerCase()).includes('data')); const headers = dataRows[headerRowIndex]; const records = dataRows.slice(headerRowIndex + 1); quotesData_IR = records.map(row => { const obj = {}; headers.forEach((header, i) => { if (header) obj[header.trim()] = row[i]; }); return obj; }).filter(row => Object.values(row).some(val => val !== null && val.toString().trim() !== '')); } }, error: (error) => showError('results', `Erro ao ler o arquivo ${file.name}: ${error.message}`) });
        }
        function processFiles_IR() {
            if (!tradesData_IR || !quotesData_IR) { showError('results', 'Por favor, carregue os dois arquivos para continuar.'); return; }
            loader_IR.classList.remove('hidden'); buttonText_IR.textContent = 'Processando...'; processButton_IR.disabled = true;
            setTimeout(() => { try { const { apuracaoMensal, plataforma, processedTrades, impostoAnual } = apurarImposto_IR(tradesData_IR, quotesData_IR); finalReportData_IR = apuracaoMensal; allProcessedTrades_IR = processedTrades; displayResults_IR(apuracaoMensal, plataforma, impostoAnual); } catch (error) { showError('results', `Ocorreu um erro no cálculo: ${error.message}.`); console.error(error); } finally { loader_IR.classList.add('hidden'); buttonText_IR.textContent = 'Apurar Impostos'; processButton_IR.disabled = false; } }, 100);
        }
        function identifyPlatform_IR(data) {
            if (!data || data.length === 0) throw new Error("O arquivo de operações está vazio.");
            const columns = new Set(Object.keys(data[0]).map(c => c.toLowerCase().trim().replace(/\s+/g, ' ')));
            if (columns.has('position') && columns.has('ativo') && columns.has('horário') && columns.has('lucro')) return { name: 'Metatrader 5 (Posições)', map: { data_fechamento: 'Horário', resultado: 'Lucro', comissao: 'Comissão', swap: 'Swap', ativo: 'Ativo' } };
            if (columns.has('n. do trade') && columns.has('datade fechamento')) return { name: 'Metatrader 5 (Negócios)', map: { data_fechamento: 'Datade  Fechamento', resultado: 'Resultado', comissao: 'Comissão', swap: 'Swap', ativo: 'Ativo' } };
            if (columns.has('position') && columns.has('type') && columns.has('deal')) return { name: 'Metatrader 5 (Inglês)', map: { data_fechamento: 'Time', resultado: 'Profit', comissao: 'Commission', swap: 'Swap', ativo: 'Symbol' } };
            if (columns.has('ticket') && columns.has('open time') && columns.has('close time')) return { name: 'Metatrader 4', map: { data_fechamento: 'Close Time', resultado: 'Profit', comissao: 'Commission', swap: 'Swap', ativo: 'Item' } };
            if (columns.has('tradeid') && columns.has('direction') && columns.has('close time')) return { name: 'CTrader', map: { data_fechamento: 'Close Time', resultado: 'Net Profit', comissao: 'Commissions', swap: 'Swap', ativo: 'Symbol' } };
            return null;
        }
        function apurarImposto_IR(trades, quotes) {
            const platformInfo = identifyPlatform_IR(trades); if (!platformInfo) throw new Error("Plataforma de trading não identificada.");
            const normalize = (obj, map) => { const newObj = {}; for (const key in obj) { const nKey = key.toLowerCase().trim().replace(/\s+/g, ' '); const sKey = Object.keys(map).find(k => map[k].toLowerCase().trim().replace(/\s+/g, ' ') === nKey); if (sKey) newObj[sKey] = obj[key]; else newObj[key.toLowerCase().trim().replace(/\s+/g, '_')] = obj[key]; } return newObj; };
            let processedTrades = trades.map(t => normalize(t, platformInfo.map));
            if (!quotes || quotes.length === 0) throw new Error("O arquivo de cotações está vazio.");
            const quotesDateKey = Object.keys(quotes[0]).find(k => k.toLowerCase().trim().includes('data'));
            const quotesCompraKey = Object.keys(quotes[0]).find(k => k.toLowerCase().trim() === 'compra');
            if (!quotesDateKey || !quotesCompraKey) throw new Error("Não foi possível encontrar as colunas 'Data' e 'Compra' no arquivo de cotações.");
            const quotesMap = quotes.reduce((acc, row) => { const dateStr = row[quotesDateKey]; if (!dateStr) return acc; let date; if (dateStr.includes('/')) { const parts = dateStr.split(' ')[0].split('/'); date = new Date(Date.UTC(parts[2], parts[1] - 1, parts[0])); } else { const parts = dateStr.split(' ')[0].split('-'); date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); } if (!isNaN(date.getTime())) acc[date.toISOString().split('T')[0]] = parseFloat(String(row[quotesCompraKey]).replace(/[^0-9,]/g, '').replace(',', '.')); return acc; }, {});
            processedTrades = processedTrades.map(trade => { const parseCurrency = (v) => parseFloat(String(v||'0').replace(/\s/g, '').replace(',', '.'))||0; const resultado_liquido_usd = parseCurrency(trade.resultado) + parseCurrency(trade.comissao) + parseCurrency(trade.swap); let date; const dateStr = (trade.data_fechamento||'').split(' ')[0]; if (dateStr.includes('/')) { const p = dateStr.split('/'); date = new Date(Date.UTC(p[2], p[1]-1, p[0])); } else { date = new Date(dateStr.replace(/\./g, '-') + 'T00:00:00Z'); } if (isNaN(date.getTime())) throw new Error(`Data inválida: ${trade.data_fechamento}`); const isoDate = date.toISOString().split('T')[0]; let quote = null; for(let i=0;i<7;i++){ const cDate=new Date(date); cDate.setUTCDate(cDate.getUTCDate()-i); const cIso=cDate.toISOString().split('T')[0]; if(quotesMap[cIso]){quote=quotesMap[cIso];break;}} const resultado_liquido_brl = quote ? resultado_liquido_usd * quote : 0; return { ...trade, data_iso: isoDate, mes_ano: isoDate ? isoDate.substring(0, 7) : null, resultado_liquido_usd, resultado_liquido_brl }; }).filter(t => t.mes_ano);
            const monthlyGroups = processedTrades.reduce((acc, trade) => { const month = trade.mes_ano; if (!acc[month]) acc[month] = { r_brl: 0, r_usd: 0 }; acc[month].r_brl += trade.resultado_liquido_brl; acc[month].r_usd += trade.resultado_liquido_usd; return acc; }, {});
            const apuracaoMensal = Object.keys(monthlyGroups).sort().map(month => ({ mes: month, resultado_liquido_brl: monthlyGroups[month].r_brl, resultado_liquido_usd: monthlyGroups[month].r_usd }));
            const lucro_total_anual_brl = processedTrades.reduce((sum, trade) => sum + trade.resultado_liquido_brl, 0);
            const impostoAnual = lucro_total_anual_brl > 0 ? lucro_total_anual_brl * 0.15 : 0;
            return { apuracaoMensal, plataforma: platformInfo.name, processedTrades, impostoAnual };
        }
        function displayResults_IR(data, plataforma, impostoAnual) {
            document.getElementById('success-box').innerHTML = `<strong>Plataforma identificada:</strong> ${plataforma}. <strong>Cálculo atualizado conforme Lei 14.754/2023.</strong>`;
            const calendarContainer = document.getElementById('calendar-container'); calendarContainer.innerHTML = '';
            const monthNames = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
            data.forEach(row => { const [year, monthNum] = row.mes.split('-'); const monthName = `${monthNames[parseInt(monthNum)-1]} ${year}`; const card = document.createElement('div'); card.className = `month-card ${row.resultado_liquido_usd >= 0 ? 'profit' : 'loss'}`; card.dataset.month = row.mes; card.innerHTML = `<div class="month-name">${monthName}</div><div class="month-result ${row.resultado_liquido_usd >= 0 ? 'text-positive' : 'text-negative'}">${formatCurrency(row.resultado_liquido_usd, 'USD')}</div><div class="month-result text-sm opacity-75">${formatCurrency(row.resultado_liquido_brl, 'BRL')}</div>`; card.addEventListener('click', () => openTradesModal_IR(row.mes, monthName)); calendarContainer.appendChild(card); });
            let totalUSD = data.reduce((s, r) => s + r.resultado_liquido_usd, 0); let totalBRL = data.reduce((s, r) => s + r.resultado_liquido_brl, 0);
            const resultadoAposDarf = totalBRL - impostoAnual;
            irKpiData = { totalUSD, totalBRL, impostoAnual, resultadoAposDarf };
            document.getElementById('total-brl').className = `summary-hero-value ${totalBRL >= 0 ? 'text-positive' : 'text-negative'}`;
            document.getElementById('total-brl').textContent = formatCurrency(totalBRL);
            document.getElementById('total-usd').textContent = formatCurrency(totalUSD, 'USD');
            document.getElementById('total-tax').textContent = formatCurrency(impostoAnual);
            document.getElementById('total-after-tax').textContent = formatCurrency(resultadoAposDarf);
            const chartCanvas = document.getElementById('monthly-performance-chart'); if (window.myPerformanceChart) window.myPerformanceChart.destroy();
            window.myPerformanceChart = new Chart(chartCanvas, { type: 'bar', data: { labels: data.map(r => `${monthNames[parseInt(r.mes.split('-')[1])-1].substring(0,3)}/${r.mes.split('-')[0].substring(2,4)}`), datasets: [{ label: 'Resultado (BRL)', data: data.map(r => r.resultado_liquido_brl), backgroundColor: data.map(r => r.resultado_liquido_brl >= 0 ? 'rgba(32, 191, 107, 0.7)' : 'rgba(252, 92, 101, 0.7)'), borderColor: data.map(r => r.resultado_liquido_brl >= 0 ? 'rgba(32, 191, 107, 1)' : 'rgba(252, 92, 101, 1)'), borderWidth: 1 }] }, options: { maintainAspectRatio: false, responsive: true, scales: { y: { ticks: { color: 'var(--text-secondary)', callback: (v) => 'R$ '+v.toLocaleString('pt-BR') }, grid: { color: 'var(--border-color)' } }, x: { ticks: { color: 'var(--text-secondary)' }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Resultado: ${formatCurrency(c.parsed.y)}` } } } } });
            resultsSection_IR.classList.remove('hidden');
        }
        function openTradesModal_IR(month, monthName) {
            const modalTitle = document.getElementById('modal-title'); const modalTableBody = document.getElementById('modal-table-body');
            modalTitle.textContent = `Operações de ${monthName}`; modalTableBody.innerHTML = '';
            const tradesForMonth = allProcessedTrades_IR.filter(trade => trade.mes_ano === month);
            tradesForMonth.forEach(trade => { const tr = document.createElement('tr'); const resultClass = trade.resultado_liquido_usd >= 0 ? 'text-positive' : 'text-negative'; tr.innerHTML = `<td class="px-4 py-3 text-sm text-text-secondary">${new Date(trade.data_iso+'T00:00:00Z').toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td class="px-4 py-3 text-sm text-text-primary">${trade.ativo}</td><td class="px-4 py-3 text-sm text-right font-semibold ${resultClass}">${formatCurrency(trade.resultado_liquido_usd,'USD')}</td><td class="px-4 py-3 text-sm text-right font-semibold ${resultClass}">${formatCurrency(trade.resultado_liquido_brl,'BRL')}</td>`; modalTableBody.appendChild(tr); });
            modal_IR.classList.add('active');
        }
        
        // =======================================================================
        // LÓGICA DE EXPORTAÇÃO
        // =======================================================================
        const { jsPDF } = window.jspdf;
        const exportModal = document.getElementById('export-modal'); const exportModalTitle = document.getElementById('export-modal-title'); const closeExportModalBtn = document.getElementById('close-export-modal-btn'); const exportOptionsContainer = document.getElementById('export-options-container'); const generateExportBtn = document.getElementById('generate-export-btn'); let currentExportType = null;
        function openExportModal(type) {
            currentExportType = type; exportOptionsContainer.innerHTML = ''; let optionsHtml = '';
            if (type === 'ir') { exportModalTitle.textContent = "Exportar Relatório de IR"; optionsHtml = `<label class="custom-checkbox-label"><input type="checkbox" id="include-ir-summary" class="custom-checkbox" checked> Incluir Resumo Anual</label><label class="custom-checkbox-label"><input type="checkbox" id="include-ir-monthly" class="custom-checkbox" checked> Incluir Resumo Mensal</label><label class="custom-checkbox-label"><input type="checkbox" id="include-ir-details" class="custom-checkbox"> Incluir Todas as Operações</label>`; } 
            else if (type === 'cambial') { exportModalTitle.textContent = "Exportar Relatório Cambial"; optionsHtml = `<label class="custom-checkbox-label"><input type="checkbox" id="include-cambial-summary" class="custom-checkbox" checked> Incluir Resumo Geral</label>`; }
            exportOptionsContainer.innerHTML = optionsHtml; exportModal.classList.add('active');
        }
        function closeExportModal() { exportModal.classList.remove('active'); }
        closeExportModalBtn.addEventListener('click', closeExportModal);
        exportModal.addEventListener('click', (e) => { if (e.target === exportModal) closeExportModal(); });
        generateExportBtn.addEventListener('click', () => {
            const format = document.getElementById('export-format-select').value;
            const btnText = document.getElementById('export-btn-text'); const loader = document.getElementById('export-loader');
            btnText.textContent = 'Gerando...'; loader.classList.remove('hidden'); generateExportBtn.disabled = true;
            setTimeout(() => { if (currentExportType === 'ir') { format === 'pdf' ? generateProfessionalPDF_IR() : generateProfessionalXLS_IR(); } else if (currentExportType === 'cambial') { format === 'pdf' ? generateProfessionalPDF_Cambial() : generateProfessionalXLS_Cambial(); } btnText.textContent = 'Gerar e Baixar'; loader.classList.add('hidden'); generateExportBtn.disabled = false; closeExportModal(); }, 500);
        });
        function addPdfHeaderFooter(doc, title) { const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(14).setTextColor('#000000').text(title, 14, 20); doc.setFontSize(10).setTextColor('#000000').text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width - 35, doc.internal.pageSize.height - 10); doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, doc.internal.pageSize.height - 10); } }
        function generateProfessionalPDF_IR() { if (!finalReportData_IR) { alert('Dados não processados.'); return; } const doc = new jsPDF(); const user = auth.currentUser; doc.setFontSize(18).text('Relatório de Apuração Anual de IR', 14, 30); doc.setFontSize(11).text(`Contribuinte: ${user.email}`, 14, 38); let finalY = 45; if (document.getElementById('include-ir-summary').checked) { const kpi = irKpiData; const summaryText = `Resultado Líquido (BRL): ${formatCurrency(kpi.totalBRL)}\nImposto Devido (DARF): ${formatCurrency(kpi.impostoAnual)}\nResultado Final (Após DARF): ${formatCurrency(kpi.resultadoAposDarf)}`; doc.setFontSize(12).setTextColor('#000000').text('Resumo Anual', 14, finalY); finalY += 7; doc.setFontSize(10).setTextColor('#000000').text(summaryText, 14, finalY); finalY += 25; } if (document.getElementById('include-ir-monthly').checked) { const head = [['Mês', 'Resultado (USD)', 'Resultado (BRL)']]; const body = finalReportData_IR.map(row => [`${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][parseInt(row.mes.split('-')[1])-1]}/${row.mes.split('-')[0]}`, formatCurrency(row.resultado_liquido_usd, 'USD'), formatCurrency(row.resultado_liquido_brl)]); doc.autoTable({ head, body, startY: finalY, headStyles: {fillColor: '#1E1E26'} }); finalY = doc.autoTable.previous.finalY + 10; } if (document.getElementById('include-ir-details').checked) { if (finalY > 45) doc.addPage(); const head = [['Data', 'Ativo', 'Resultado (USD)', 'Resultado (BRL)']]; const body = allProcessedTrades_IR.map(t => [new Date(t.data_iso + 'T00:00:00Z').toLocaleDateString('pt-BR'), t.ativo, formatCurrency(t.resultado_liquido_usd, 'USD'), formatCurrency(t.resultado_liquido_brl)]); doc.autoTable({ head, body, startY: 30, headStyles: {fillColor: '#1E1E26'} }); } addPdfHeaderFooter(doc, 'Relatório de IR'); doc.save(`Relatorio_IR_${user.email.split('@')[0]}.pdf`); }
        function generateProfessionalXLS_IR() { if (!finalReportData_IR) { alert('Dados não processados.'); return; } const wb = XLSX.utils.book_new(); if (document.getElementById('include-ir-summary').checked) { const kpi = irKpiData; const data = [['Resumo Anual', 'Valor'], ['Resultado Líquido (BRL)', kpi.totalBRL], ['Imposto Devido (DARF)', kpi.impostoAnual], ['Resultado Final (Após DARF)', kpi.resultadoAposDarf], ['Resultado Líquido (USD)', kpi.totalUSD]]; const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch: 30}, {wch: 20}]; XLSX.utils.book_append_sheet(wb, ws, 'Resumo Anual'); } if (document.getElementById('include-ir-monthly').checked) { const data = finalReportData_IR.map(row => ({ 'Mês': row.mes, 'Resultado Líquido (USD)': row.resultado_liquido_usd, 'Resultado Líquido (BRL)': row.resultado_liquido_brl })); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch: 15}, {wch: 25}, {wch: 25}]; XLSX.utils.book_append_sheet(wb, ws, 'Resumo Mensal'); } if (document.getElementById('include-ir-details').checked) { const data = allProcessedTrades_IR.map(t => ({ 'Data': new Date(t.data_iso + 'T00:00:00Z'), 'Ativo': t.ativo, 'Resultado (USD)': t.resultado_liquido_usd, 'Resultado (BRL)': t.resultado_liquido_brl })); const ws = XLSX.utils.json_to_sheet(data, { cellDates: true }); ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 20}, {wch: 20}]; XLSX.utils.book_append_sheet(wb, ws, 'Todas Operações'); } XLSX.writeFile(wb, 'Relatorio_Apuracao_IR.xlsx'); }
        function generateProfessionalPDF_Cambial() { if (Object.keys(cambialKpiData).length === 0) { alert('Dados não processados.'); return; } const doc = new jsPDF(); const user = auth.currentUser; let finalY = 45; doc.setFontSize(18).text('Relatório de Envios e Retiradas', 14, 30); doc.setFontSize(11).text(`Contribuinte: ${user.email}`, 14, 38); if (document.getElementById('include-cambial-summary').checked) { const kpi = cambialKpiData; const summaryText = `Variação Cambial Total: ${formatCurrency(kpi.lucroPrejuizoTotal)}\nImposto Devido sobre Retiradas: ${formatCurrency(kpi.impostoDevido)}\nSaldo Atual (USD): ${formatCurrency(kpi.saldoUSD, 'USD')}\nSaldo Atual (BRL): ${formatCurrency(kpi.custoSaldoBRL)}`; doc.setFontSize(12).setTextColor('#000000').text('Resumo Geral', 14, finalY); finalY += 7; doc.setFontSize(10).setTextColor('#000000').text(summaryText, 14, finalY); finalY += 30; } const head = [cambialExportData.headers]; const body = cambialExportData.data.map(row => Object.values(row).map(val => typeof val === 'number' ? val.toFixed(2) : val)); doc.autoTable({ head, body, startY: finalY, headStyles: {fillColor: '#1E1E26'} }); addPdfHeaderFooter(doc, 'Relatório Cambial'); doc.save(`Relatorio_Cambial_${user.email.split('@')[0]}.pdf`); }
        function generateProfessionalXLS_Cambial() { if (Object.keys(cambialKpiData).length === 0) { alert('Dados não processados.'); return; } const wb = XLSX.utils.book_new(); if (document.getElementById('include-cambial-summary').checked) { const kpi = cambialKpiData; const data = [['Resumo Cambial', 'Valor'], ['Variação Cambial Total (BRL)', kpi.lucroPrejuizoTotal], ['Imposto Devido s/ Retiradas (BRL)', kpi.impostoDevido], ['Total Enviado (USD)', kpi.totalEnviosUSD], ['Total Retirado (USD)', kpi.totalRetiradoUSD], ['Saldo Atual (USD)', kpi.saldoUSD], ['Total Enviado (BRL)', kpi.totalEnviosBRL], ['Total Retirado (BRL)', kpi.totalRetiradoBRL], ['Saldo Atual (BRL)', kpi.custoSaldoBRL]]; const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{wch: 35}, {wch: 20}]; XLSX.utils.book_append_sheet(wb, ws, 'Resumo'); } const ws = XLSX.utils.json_to_sheet(cambialExportData.data); ws['!cols'] = [{wch: 12}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 30}, {wch: 20}]; XLSX.utils.book_append_sheet(wb, ws, 'Extrato Detalhado'); XLSX.writeFile(wb, 'Relatorio_Envios_Retiradas.xlsx'); }

    </script>
</body>
</html>
